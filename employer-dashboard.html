<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NBVS — Employer Dashboard</title>

<style>
  :root {
    --red:#ce1126;
    --yellow:#fcd116;
    --green:#046c4e;
    --bg:#f6f7f9;
    --card:#ffffff;
    --muted:#6b7280;
  }

  body{
    margin:0;
    background:var(--bg);
    font-family:"Inter",sans-serif;
    color:#111;
  }

  header{
    background:linear-gradient(90deg,var(--red),var(--yellow),var(--green));
    padding:18px;
    color:#fff;
    text-align:center;
    font-weight:700;
    box-shadow:0 4px 20px rgba(0,0,0,0.15);
  }

  main{
    max-width:900px;
    margin:20px auto;
    padding:0 16px;
  }

  .panel{
    background:var(--card);
    padding:18px;
    border-radius:12px;
    margin-bottom:18px;
    box-shadow:0 6px 20px rgba(0,0,0,0.07);
  }

  h2, h3{
    margin-top:0;
    color:var(--green);
  }

  input{
    width:100%;
    padding:12px;
    border-radius:8px;
    border:1px solid #ccc;
    margin-top:6px;
    font-size:1rem;
  }

  button{
    padding:12px;
    border-radius:8px;
    border:none;
    cursor:pointer;
    font-weight:700;
  }

  .btn-green{ background:var(--green); color:#fff; }
  .btn-yellow{ background:var(--yellow); color:#111; }
  .btn-red{ background:var(--red); color:#fff; }

  .row{
    display:flex;
    gap:10px;
    margin-top:10px;
  }

  .record{
    background:#fff;
    border-left:5px solid var(--green);
    padding:12px;
    border-radius:10px;
    margin-top:12px;
  }

  .small{
    font-size:0.88rem;
    color:var(--muted);
  }
</style>
</head>

<body>
<header>
  <h1>Employer Dashboard — NBVS</h1>
</header>

<main id="app" style="display:none">
  
  <!-- WALLET OVERVIEW -->
  <div class="panel">
    <h2>Wallet</h2>
    <p style="font-size:1.5rem;font-weight:700">
      Balance: ¢<span id="walletBalance">—</span>
    </p>

    <button class="btn-yellow" id="openWallet">Open Wallet</button>
  </div>

  <!-- SEARCH FORM -->
  <div class="panel">
    <h2>Run a Background Check</h2>

    <label>Full Name or NIA</label>
    <input id="searchInput" placeholder="e.g. Kojo Mensah or GHA-293845" />

    <div class="row">
      <button id="searchBtn" class="btn-green" style="flex:1">
        Run Check
      </button>
    </div>

    <div id="resultsArea" style="margin-top:12px"></div>
  </div>

  <!-- RECENT SEARCHES -->
  <div class="panel">
    <h3>Recent Searches</h3>
    <div id="logsArea">
      <p class="small">Loading your history…</p>
    </div>
  </div>

  <button id="logoutBtn" class="btn-red" style="width:100%;margin-top:12px;">
    Logout
  </button>

</main>


<script type="module">
/* -----------------------------------------------------
   FIREBASE IMPORTS
----------------------------------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { 
  getAuth, onAuthStateChanged, signOut 
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, updateDoc,
  collection, addDoc, query, where, getDocs, orderBy, limit
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";


/* -----------------------------------------------------
   CONFIG
----------------------------------------------------- */
const firebaseConfig = {
  apiKey:"AIzaSyCDh_qL3jiCMHROK0_Soul2Wsv3t3y4wv0",
  authDomain:"nbvs-ghana.firebaseapp.com",
  projectId:"nbvs-ghana",
  storageBucket:"nbvs-ghana.firebasestorage.app",
  messagingSenderId:"702636577113",
  appId:"1:702636577113:web:8369b43a2aa43aeb95fc48"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);


/* -----------------------------------------------------
   ELEMENTS
----------------------------------------------------- */
const appEl          = document.getElementById("app");
const searchInput    = document.getElementById("searchInput");
const searchBtn      = document.getElementById("searchBtn");
const resultsArea    = document.getElementById("resultsArea");
const walletBalance  = document.getElementById("walletBalance");
const openWallet     = document.getElementById("openWallet");
const logsArea       = document.getElementById("logsArea");
const logoutBtn      = document.getElementById("logoutBtn");

let employerId = null;


/* -----------------------------------------------------
   AUTH CHECK — ONLY EMPLOYERS
----------------------------------------------------- */
onAuthStateChanged(auth, async (user)=>{
  if (!user) return window.location.href = "employer-login.html";

  const uDoc = await getDoc(doc(db,"users",user.uid));
  if (!uDoc.exists()){
    alert("No employer record found.");
    return;
  }

  const role = (uDoc.data().role || "").toLowerCase();
  if (role !== "employer"){
    alert("Employer access only.");
    await signOut(auth);
    return window.location.href = "employer-login.html";
  }

  employerId = user.uid;
  appEl.style.display = "block";

  loadWallet();
  loadLogs();
});


/* -----------------------------------------------------
   WALLET
----------------------------------------------------- */
async function loadWallet(){
  const snap = await getDoc(doc(db,"users", employerId));
  const data = snap.data();
  walletBalance.innerText = data.wallet ?? 0;
}

openWallet.onclick = () => window.location.href = "wallet.html";


/* -----------------------------------------------------
   SEARCH ENGINE (uses your existing logic)
----------------------------------------------------- */
async function performSearch(term){
  const results = [];
  const trimmed = term.trim();
  if (!trimmed) return results;

  const ref = collection(db,"records");

  // 1. NIA match
  const snapNia = await getDocs(query(ref, where("nia","==", trimmed), limit(50)));
  snapNia.forEach(d => results.push(d));

  // 2. Exact name match
  const lower = trimmed.toLowerCase();
  const snapName = await getDocs(query(ref, where("name_lower","==", lower), limit(200)));
  snapName.forEach(d => { if (!results.some(x=>x.id===d.id)) results.push(d); });

  return results;
}

function renderResults(list){
  resultsArea.innerHTML = "";

  if (!list.length){
    resultsArea.innerHTML = `<p class="small">No record found.</p>`;
    return;
  }

  list.forEach(d=>{
    const r = d.data();
    const div = document.createElement("div");
    div.className = "record";
    div.innerHTML = `
      <p><b>Name:</b> ${r.name||""}</p>
      <p><b>NIA:</b> ${r.nia||""}</p>
      <p><b>DOB:</b> ${r.dob||""}</p>
      <p><b>Region:</b> ${r.region||""}</p>
      <p><b>Address:</b> ${r.address||""}</p>
      <p><b>Criminal:</b> ${r.criminal||""}</p>
      <p><b>Driving:</b> ${r.driving||""}</p>
      <p><b>Credit:</b> ${r.credit||""}</p>
    `;
    resultsArea.appendChild(div);
  });
}


/* -----------------------------------------------------
   RUN SEARCH
----------------------------------------------------- */
searchBtn.onclick = async () => {
  const term = searchInput.value.trim();
  if (!term){
    resultsArea.innerHTML = `<p class="small">Enter something to search.</p>`;
    return;
  }

  resultsArea.innerHTML = `<p class="small">Searching…</p>`;

  const docs = await performSearch(term);
  renderResults(docs);

  await addDoc(collection(db,"search_logs"),{
    employerId,
    term,
    found: docs.length>0,
    timestamp: new Date(),
  });

  await loadLogs();
};


/* -----------------------------------------------------
   LOG HISTORY
----------------------------------------------------- */
async function loadLogs(){
  const q = query(
    collection(db,"search_logs"),
    where("employerId","==",employerId),
    orderBy("timestamp","desc"),
    limit(10)
  );

  const snap = await getDocs(q);

  if (snap.empty){
    logsArea.innerHTML = `<p class="small">No searches yet.</p>`;
    return;
  }

  logsArea.innerHTML = "";
  snap.forEach(d=>{
    const r = d.data();
    logsArea.innerHTML += `
      <div class="record">
        <b>${r.term}</b><br>
        <span class="small">Found: ${r.found ? "Yes" : "No"}</span><br>
        <span class="small">${new Date(r.timestamp).toLocaleString()}</span>
      </div>
    `;
  });
}


/* -----------------------------------------------------
   LOGOUT
----------------------------------------------------- */
logoutBtn.onclick = async () => {
  await signOut(auth);
  window.location.href = "employer-login.html";
};
</script>

</body>
</html>
