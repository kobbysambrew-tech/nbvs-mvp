<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NBVS Ghana ‚Äî Verify Record</title>
  <style>
    body { font-family: Arial; background: #f8f9fa; margin: 0; padding: 0; }
    header { background: linear-gradient(to right, #ce1126, #fcd116, #006b3f); color: white; text-align: center; padding: 1.4em; }
    main { max-width: 700px; margin: 2em auto; background: white; padding: 1.8em; border-radius: 10px; }
    input { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 6px; border: 1px solid #ccc; }
    button { background: #006b3f; color: white; padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #004f2e; }
    .record { background: #f1f1f1; padding: 12px; margin-top: 15px; border-left: 4px solid #006b3f; }
  </style>
</head>
<body>
  <header><h1>NBVS Ghana ‚Äî Verify Background Record</h1></header>

  <main>
    <h2>Search Individual Record</h2>
    <p style="background:#006b3f; color:white; padding:8px; border-radius:6px;">
  ‚úÖ Free Searches Remaining: <b id="freeCount">3</b>
</p>

    <input id="searchInput" placeholder="Enter Name or NIA ID" />
    <button id="searchBtn">Search</button>
    <div id="results"></div>
  </main>
<!-- ‚úÖ Subscription / Usage Zone -->
<section id="billingSection" style="margin-top:20px; background:#fff; padding:15px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.15);">

  <h2>NBVS Access</h2>

  <p id="freeSearchesDisplay" style="font-size:1.1em; font-weight:600;">
    Free Searches: Loading...
  </p>

  <p id="planDisplay" style="font-size:1.1em;">
    Current Plan: Loading...
  </p>

  <hr>

  <h3>Upgrade Plans</h3>

  <!-- ‚úÖ BASIC PLAN -->
  <button id="buyBasicBtn" style="
    background:#006b3f; 
    color:white;
    border:none;
    padding:10px 16px;
    border-radius:6px;
    cursor:pointer;
    width:100%;
    margin-bottom:8px;">
    Buy BASIC Access (10 searches) ‚Äî $3.99
  </button>

  <!-- ‚úÖ PRO PLAN -->
  <button id="buyProBtn" style="
    background:#ce1126; 
    color:white;
    border:none;
    padding:10px 16px;
    border-radius:6px;
    cursor:pointer;
    width:100%;
    margin-bottom:8px;">
    Buy PRO Unlimited (30 days) ‚Äî $14.99
  </button>

  <!-- ‚úÖ NBVS WALLET -->
  <button id="walletBtn" style="
    background:#fcd116; 
    color:#222;
    border:none;
    padding:10px 16px;
    border-radius:6px;
    cursor:pointer;
    width:100%;
    font-weight:bold;">
    NBVS Wallet
  </button>
</section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

// ‚úÖ Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCDh_qL3jiCMHROK0_Soul2Wsv3t3y4wv0",
  authDomain: "nbvs-ghana.firebaseapp.com",
  projectId: "nbvs-ghana",
  storageBucket: "nbvs-ghana.firebasestorage.app",
  messagingSenderId: "702636577113",
  appId: "1:702636577113:web:8369b43a2aa43aeb95fc48",
  measurementId: "G-2FHFSQRMZX"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ‚úÖ Current user (anonymous for now)
const userId = "publicUser";

// ‚úÖ Default data for first-time visitors
async function ensureUserRecord() {
  const userRef = doc(db, "users", userId);
  const snap = await getDoc(userRef);

  if (!snap.exists()) {
    await setDoc(userRef, {
      freeSearches: 3,
      plan: "free",            // free | basic | pro
      planExpires: null,
      monthlyRemaining: 0      // only for basic plan
    });
  }
}

await ensureUserRecord();

// ‚úÖ Fetch user subscription data
async function getUser() {
  const snap = await getDoc(doc(db, "users", userId));
  return snap.data();
}

// ‚úÖ Update user info
async function updateUser(data) {
  await setDoc(doc(db, "users", userId), data, { merge: true });
}

  // ‚úÖ Track free searches in localStorage
  if (!localStorage.getItem("freeSearches")) {
    localStorage.setItem("freeSearches", 3); 
  }

  function updateFreeSearchUI() {
    let count = localStorage.getItem("freeSearches");
    document.getElementById("freeCount").innerText = count;
  }

  updateFreeSearchUI();

  async function searchRecord() {
    let free = parseInt(localStorage.getItem("freeSearches"));

    // ‚úÖ If no free searches left ‚Üí show paywall
    if (free <= 0) {
      document.getElementById("results").innerHTML = `
        <div style="padding:20px; text-align:center;">
          <h2>‚ö†Ô∏è Search Limit Reached</h2>
          <p>You have used your 3 free searches.</p>
          <button onclick="buyCredits()" 
            style="padding:10px 18px; background:#006b3f; color:#fff; border:none; border-radius:6px;">
            Buy More Searches
          </button>
        </div>
      `;
      return;
    }

    // ‚úÖ Normal search
    const queryValue = document.getElementById("searchInput").value.trim().toLowerCase();
    const resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = "Searching...";

    try {
      const allDocs = await getDocs(collection(db, "records"));
      let matches = [];
      allDocs.forEach(doc => {
        const r = doc.data();
        if (r.name?.toLowerCase() === queryValue || r.nia?.toLowerCase() === queryValue) {
          matches.push(r);
        }
      });

      // ‚úÖ Deduct a free search ONLY if query is valid
      free -= 1;
      localStorage.setItem("freeSearches", free);
      updateFreeSearchUI();

      if (matches.length === 0) {
        resultsDiv.innerHTML = `<p style="color:#c00;">‚ùå Record not found.</p>`;
        return;
      }

      // ‚úÖ Show results
      resultsDiv.innerHTML = "";
      matches.forEach(r => {
        resultsDiv.innerHTML += `
          <div class="record">
            <h3>${r.name} ‚Äî <span class="${r.status}">${r.status}</span></h3>
            <p><b>NIA ID:</b> ${r.nia}</p>
            <p><b>Date of Birth:</b> ${r.dob}</p>
            <p><b>Region:</b> ${r.region}</p>
            <p><b>Criminal:</b> ${r.criminal}</p>
            <p><b>Driving:</b> ${r.driving}</p>
            <p><b>Address:</b> ${r.address}</p>
            <p><b>Credit:</b> ${r.credit}</p>
          </div>
        `;
      });

    } catch (error) {
      resultsDiv.innerHTML = "<p>‚ö†Ô∏è Error fetching records.</p>";
      console.error(error);
    }
  }
/*  
 --------------------------------------------
 ‚úÖ NBVS Ghana ‚Äì Monetization & Access Control
---------------------------------------------
 Features enabled:
 ‚úÖ 3 free searches
 ‚úÖ BASIC plan ‚Äì 10 searches ($3.99)
 ‚úÖ PRO plan ‚Äì Unlimited 30 days ($14.99)
 ‚úÖ NBVS Wallet (global balance)
 ‚úÖ Access lock/unlock
 ‚úÖ Auto UI update
---------------------------------------------
*/

// ‚úÖ Firebase imports already present (do NOT duplicate them)
// We assume:
// const app = initializeApp(firebaseConfig);
// const db  = getFirestore(app);

// ‚úÖ Reference to the stats document
import { doc, getDoc, setDoc, updateDoc } 
from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

const statsDoc = doc(db, "stats", "global");

// ‚úÖ DOM elements
const freeSearchesDisplay = document.getElementById("freeSearchesDisplay");
const planDisplay = document.getElementById("planDisplay");
const buyBasicBtn = document.getElementById("buyBasicBtn");
const buyProBtn = document.getElementById("buyProBtn");
const walletBtn = document.getElementById("walletBtn");


// ‚úÖ Local storage tracking
function getUserData() {
  return {
    freeSearches: parseInt(localStorage.getItem("freeSearches") || "3"),
    plan: localStorage.getItem("plan") || "FREE",
    planExpiry: localStorage.getItem("planExpiry") || null
  };
}

function saveUserData(data) {
  localStorage.setItem("freeSearches", data.freeSearches);
  localStorage.setItem("plan", data.plan);
  if (data.planExpiry) localStorage.setItem("planExpiry", data.planExpiry);
}


// ‚úÖ Check if PRO plan expired
function checkProExpiry() {
  const now = Date.now();
  const expiry = parseInt(localStorage.getItem("planExpiry") || "0");
  if (expiry && now > expiry) {
    localStorage.setItem("plan", "FREE");
    alert("‚ö†Ô∏è Your PRO plan expired.");
  }
}


// ‚úÖ Update UI display
function updateUI() {
  checkProExpiry();
  const data = getUserData();

  freeSearchesDisplay.textContent = `Free Searches: ${data.freeSearches}`;
  planDisplay.textContent = `Current Plan: ${data.plan}`;
}


// ‚úÖ Deduct search on use
async function deductSearch() {
  checkProExpiry();
  const data = getUserData();

  // ‚úÖ PRO plan ‚Äì unlimited
  if (data.plan === "PRO") {
    return true;
  }

  // ‚úÖ BASIC plan ‚Äì has limited searches
  if (data.plan === "BASIC") {
    if (data.freeSearches > 0) {
      data.freeSearches -= 1;
      saveUserData(data);
      updateUI();
      return true;
    } else {
      alert("‚ùå BASIC plan search limit reached.");
      return false;
    }
  }

  // ‚úÖ FREE plan ‚Äì 3 free searches
  if (data.plan === "FREE") {
    if (data.freeSearches > 0) {
      data.freeSearches -= 1;
      saveUserData(data);
      updateUI();
      return true;
    } else {
      alert("‚ùå Free searches used up. Please upgrade your plan.");
      return false;
    }
  }
}



// ‚úÖ MOCK PAYMENT HANDLERS (Replace with Stripe when ready)
async function addToWallet(amount) {
  const snap = await getDoc(statsDoc);
  if (!snap.exists()) {
    await setDoc(statsDoc, { walletBalance: amount });
  } else {
    const newBalance = (snap.data().walletBalance || 0) + amount;
    await updateDoc(statsDoc, { walletBalance: newBalance });
  }
}


// ‚úÖ BASIC ‚Äì $3.99 ‚Äì 10 searches
buyBasicBtn.addEventListener("click", async () => {
  alert("‚úÖ Payment simulated ‚Äî $3.99 received.");

  await addToWallet(3.99);

  saveUserData({
    freeSearches: 10,
    plan: "BASIC",
    planExpiry: null
  });

  updateUI();
  alert("‚úÖ BASIC plan activated with 10 searches.");
});


// ‚úÖ PRO ‚Äì $14.99 ‚Äì Unlimited 30 days
buyProBtn.addEventListener("click", async () => {
  alert("‚úÖ Payment simulated ‚Äî $14.99 received.");

  await addToWallet(14.99);

  const expiry = Date.now() + 30 * 24 * 60 * 60 * 1000; // 30 days

  saveUserData({
    freeSearches: 9999,
    plan: "PRO",
    planExpiry: expiry
  });

  updateUI();
  alert("‚úÖ PRO Unlimited (30 days) Activated.");
});


// ‚úÖ NBVS Wallet Viewer
walletBtn.addEventListener("click", async () => {
  const snap = await getDoc(statsDoc);
  let bal = snap.exists() ? snap.data().walletBalance : 0;

  alert(`üí∞ NBVS Global Wallet Balance: $${bal.toFixed(2)}`);
});


// ‚úÖ INIT
updateUI();

  function buyCredits() {
    alert("Payment system coming soon! (Stripe + NBVS Wallet)");
  }
</script>

</body>
</html>

