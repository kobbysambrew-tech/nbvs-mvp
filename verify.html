<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NBVS Ghana — Verify Record</title>
  <style>
    body { font-family: Arial; background: #f8f9fa; margin: 0; padding: 0; }
    header { background: linear-gradient(to right, #ce1126, #fcd116, #006b3f); color: white; text-align: center; padding: 1.4em; }
    main { max-width: 700px; margin: 2em auto; background: white; padding: 1.8em; border-radius: 10px; }
    input { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 6px; border: 1px solid #ccc; }
    button { background: #006b3f; color: white; padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #004f2e; }
    .record { background: #f1f1f1; padding: 12px; margin-top: 15px; border-left: 4px solid #006b3f; }
  </style>
</head>
<body>
  <header><h1>NBVS Ghana — Verify Background Record</h1></header>

  <main>
    <h2>Search Individual Record</h2>
    <p style="background:#006b3f; color:white; padding:8px; border-radius:6px;">
  ✅ Free Searches Remaining: <b id="freeCount">3</b>
</p>

    <input id="searchInput" placeholder="Enter Name or NIA ID" />
    <button id="searchBtn">Search</button>
    <div id="results"></div>
  </main>
<!-- ✅ Subscription / Usage Zone -->
<section id="billingSection" style="margin-top:20px; background:#fff; padding:15px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.15);">

  <h2>NBVS Access</h2>

  <p id="freeSearchesDisplay" style="font-size:1.1em; font-weight:600;">
    Free Searches: Loading...
  </p>

  <p id="planDisplay" style="font-size:1.1em;">
    Current Plan: Loading...
  </p>

  <hr>

  <h3>Upgrade Plans</h3>

  <!-- ✅ BASIC PLAN -->
  <button id="buyBasicBtn" style="
    background:#006b3f; 
    color:white;
    border:none;
    padding:10px 16px;
    border-radius:6px;
    cursor:pointer;
    width:100%;
    margin-bottom:8px;">
    Buy BASIC Access (10 searches) — $3.99
  </button>

  <!-- ✅ PRO PLAN -->
  <button id="buyProBtn" style="
    background:#ce1126; 
    color:white;
    border:none;
    padding:10px 16px;
    border-radius:6px;
    cursor:pointer;
    width:100%;
    margin-bottom:8px;">
    Buy PRO Unlimited (30 days) — $14.99
  </button>

  <!-- ✅ NBVS WALLET -->
  <button id="walletBtn" style="
    background:#fcd116; 
    color:#222;
    border:none;
    padding:10px 16px;
    border-radius:6px;
    cursor:pointer;
    width:100%;
    font-weight:bold;">
    NBVS Wallet
  </button>
</section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

// ✅ Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCDh_qL3jiCMHROK0_Soul2Wsv3t3y4wv0",
  authDomain: "nbvs-ghana.firebaseapp.com",
  projectId: "nbvs-ghana",
  storageBucket: "nbvs-ghana.firebasestorage.app",
  messagingSenderId: "702636577113",
  appId: "1:702636577113:web:8369b43a2aa43aeb95fc48",
  measurementId: "G-2FHFSQRMZX"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ✅ Current user (anonymous for now)
const userId = "publicUser";

// ✅ Default data for first-time visitors
async function ensureUserRecord() {
  const userRef = doc(db, "users", userId);
  const snap = await getDoc(userRef);

  if (!snap.exists()) {
    await setDoc(userRef, {
      freeSearches: 3,
      plan: "free",            // free | basic | pro
      planExpires: null,
      monthlyRemaining: 0      // only for basic plan
    });
  }
}

await ensureUserRecord();

// ✅ Fetch user subscription data
async function getUser() {
  const snap = await getDoc(doc(db, "users", userId));
  return snap.data();
}

// ✅ Update user info
async function updateUser(data) {
  await setDoc(doc(db, "users", userId), data, { merge: true });
}

  // ✅ Track free searches in localStorage
  if (!localStorage.getItem("freeSearches")) {
    localStorage.setItem("freeSearches", 3); 
  }

  function updateFreeSearchUI() {
    let count = localStorage.getItem("freeSearches");
    document.getElementById("freeCount").innerText = count;
  }

  updateFreeSearchUI();

  async function searchRecord() {
    let free = parseInt(localStorage.getItem("freeSearches"));

    // ✅ If no free searches left → show paywall
    if (free <= 0) {
      document.getElementById("results").innerHTML = `
        <div style="padding:20px; text-align:center;">
          <h2>⚠️ Search Limit Reached</h2>
          <p>You have used your 3 free searches.</p>
          <button onclick="buyCredits()" 
            style="padding:10px 18px; background:#006b3f; color:#fff; border:none; border-radius:6px;">
            Buy More Searches
          </button>
        </div>
      `;
      return;
    }

    // ✅ Normal search
    const queryValue = document.getElementById("searchInput").value.trim().toLowerCase();
    const resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = "Searching...";

    try {
      const allDocs = await getDocs(collection(db, "records"));
      let matches = [];
      allDocs.forEach(doc => {
        const r = doc.data();
        if (r.name?.toLowerCase() === queryValue || r.nia?.toLowerCase() === queryValue) {
          matches.push(r);
        }
      });

      // ✅ Deduct a free search ONLY if query is valid
      free -= 1;
      localStorage.setItem("freeSearches", free);
      updateFreeSearchUI();

      if (matches.length === 0) {
        resultsDiv.innerHTML = `<p style="color:#c00;">❌ Record not found.</p>`;
        return;
      }

      // ✅ Show results
      resultsDiv.innerHTML = "";
      matches.forEach(r => {
        resultsDiv.innerHTML += `
          <div class="record">
            <h3>${r.name} — <span class="${r.status}">${r.status}</span></h3>
            <p><b>NIA ID:</b> ${r.nia}</p>
            <p><b>Date of Birth:</b> ${r.dob}</p>
            <p><b>Region:</b> ${r.region}</p>
            <p><b>Criminal:</b> ${r.criminal}</p>
            <p><b>Driving:</b> ${r.driving}</p>
            <p><b>Address:</b> ${r.address}</p>
            <p><b>Credit:</b> ${r.credit}</p>
          </div>
        `;
      });

    } catch (error) {
      resultsDiv.innerHTML = "<p>⚠️ Error fetching records.</p>";
      console.error(error);
    }
  }

  function buyCredits() {
    alert("Payment system coming soon! (Stripe + NBVS Wallet)");
  }
</script>

</body>
</html>

