<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NBVS Ghana — Verify</title>

<style>
  :root{
    --red:#ce1126;
    --yellow:#fcd116;
    --green:#006b3f;
    --accent:#004f2e;
    --card:#ffffff;
    --bg:#f6f7f9;
    --muted:#555;
  }

  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:"Segoe UI",Arial,sans-serif;background:var(--bg);color:#222;}

  header{background:linear-gradient(90deg,var(--red),var(--yellow),var(--green));padding:1.8rem 1rem;text-align:center;color:white;font-weight:700;box-shadow:0 3px 12px rgba(0,0,0,0.15);}
  header h1{font-size:1.6rem;margin-bottom:4px}

  main{max-width:800px;margin:1.6rem auto;padding:0 1rem;}
  .panel{background:var(--card);padding:1.4rem;border-radius:12px;box-shadow:0 8px 26px rgba(0,0,0,0.06);margin-bottom:1.4rem;}
  h3{margin-bottom:10px;color:var(--accent)}
  input{width:100%;padding:13px;border-radius:10px;border:1px solid #ccc;margin-bottom:12px;font-size:1rem;}
  button{width:100%;padding:12px;border:none;border-radius:10px;cursor:pointer;font-weight:700;font-size:1rem;transition:.25s;}
  .btn-green{background:var(--green);color:white;}
  .btn-green:hover{background:var(--accent);transform:translateY(-3px)}
  .btn-yellow{background:var(--yellow);color:#111}
  .btn-yellow:hover{filter:brightness(.93);transform:translateY(-3px)}
  .btn-red{background:var(--red);color:white}

  .pill{padding:6px 12px;border-radius:10px;background:var(--green);color:white;font-weight:600;}
  .record{background:white;border-left:5px solid var(--green);padding:1rem;border-radius:10px;margin-top:1rem;box-shadow:0 6px 20px rgba(0,0,0,0.06);}
  .muted{color:var(--muted)}
</style>
</head>

<body>
<header>
  <h1>NBVS Ghana — Background Verification</h1>
</header>

<main>
  <p class="muted">Each verification costs ¢30. You have <span id="userPlan">loading…</span>.</p>

  <div class="panel">
    <label class="muted">Search by full name or NIA ID</label>
    <input id="searchInput" placeholder="e.g. Kofi Mensah or GHA-2039485" />

    <div style="display:flex;gap:10px">
      <button id="searchBtn" class="btn-green">Search</button>
      <button id="walletPageBtn" class="btn-yellow">Open Wallet</button>
    </div>

    <div style="margin-top:12px">
      <span class="pill" id="freeCountDisplay">Free: —</span>
      <span class="muted" id="planDisplay">Plan: —</span>
    </div>

    <!-- Progress bar for searches left -->
    <div style="margin-top:8px;">
      <label class="muted">Searches left:</label>
      <div style="background:#ddd;border-radius:10px;overflow:hidden;height:14px;margin-top:4px;">
        <div id="searchProgress" style="width:0%;height:100%;background:#006b3f;transition:width 0.3s;"></div>
      </div>
      <span id="searchProgressText" class="muted" style="font-size:0.9rem;">0/0</span>
    </div>
  </div>

  <div id="resultsArea"></div>

  <div class="panel">
    <h3>Upgrade / Buy</h3>
    <button id="buyBasicBtn" class="btn-green" style="margin-bottom:10px">BASIC — 10 searches — $3.99</button>
    <button id="buyProBtn" class="btn-red" style="margin-bottom:10px">PRO — Unlimited 30 days — $14.99</button>
    <button id="useWalletBtn" class="btn-yellow">Use Wallet (¢30)</button>
  </div>

  <div style="text-align:center;margin-top:14px">
    <a href="index.html">← Back Home</a> • 
    <a href="wallet.html">Wallet</a>
    <div id="walletBalance" class="muted" style="margin-top:4px;">¢0</div>
  </div>
</main>

<script type="module">
// -------------------- FIREBASE --------------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

// -------------------- CONFIG --------------------
const firebaseConfig = {
  apiKey:"AIzaSyCDh_qL3jiCMHROK0_Soul2Wsv3t3y4wv0",
  authDomain:"nbvs-ghana.firebaseapp.com",
  projectId:"nbvs-ghana",
  storageBucket:"nbvs-ghana.firebasestorage.app",
  messagingSenderId:"702636577113",
  appId:"1:702636577113:web:8369b43a2aa43aeb95fc48"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// -------------------- USER / WALLET --------------------
const userId = "publicUser";
const userRef = doc(db, "users", userId);
const walletRef = doc(db, "wallet", userId);

// Initialize user
async function initUser(){
  const snap = await getDoc(userRef);
  if (!snap.exists()) {
    await setDoc(userRef, { freeSearches:3, plan:"free", planExpires:null, monthlyRemaining:0 });
  }
}

// Initialize wallet
async function initWallet(){
  const snap = await getDoc(walletRef);
  if (!snap.exists()) {
    await setDoc(walletRef, { balance:0 });
  }
}

// Load user
async function loadUser(){ return (await getDoc(userRef)).data(); }
// Load wallet
async function loadWallet(){ return (await getDoc(walletRef)).data().balance || 0; }

// -------------------- UPDATE UI --------------------
function updateUI(user){
  document.getElementById("freeCountDisplay").innerText = `Free: ${user.freeSearches}`;
  document.getElementById("planDisplay").innerText = `Plan: ${user.plan}`;
  document.getElementById("userPlan").innerText = user.plan;

  // Progress bar
  let total=0, used=0;
  if(user.plan==="free"){ total=3; used=3-user.freeSearches; }
  else if(user.plan==="basic"){ total=10; used=10-user.monthlyRemaining; }
  else if(user.plan==="pro"){ total=30; used=0; }
  const percent = Math.min(100, ((total-used)/total)*100);
  document.getElementById("searchProgress").style.width = `${percent}%`;
  document.getElementById("searchProgressText").innerText = `${total-used}/${total} searches left`;
}

// Update wallet display
async function updateWalletUI(){
  const bal = await loadWallet();
  document.getElementById("walletBalance").innerText = `¢${bal}`;
}

// Deduct a search
async function deductSearch(){
  const user = await loadUser();
  if(user.plan==="pro") return true;
  if(user.plan==="basic"){
    if(user.monthlyRemaining>0){ await updateDoc(userRef,{monthlyRemaining:user.monthlyRemaining-1}); return true; }
    alert("Your BASIC plan is out of searches."); return false;
  }
  if(user.freeSearches>0){ await updateDoc(userRef,{freeSearches:user.freeSearches-1}); return true; }
  alert("You used all 3 free searches."); return false;
}

// -------------------- MAIN --------------------
async function main(){
  await initUser();
  await initWallet();

  updateUI(await loadUser());
  await updateWalletUI();

  const resultsDiv = document.getElementById("resultsArea");

  // SEARCH BUTTON
  document.getElementById("searchBtn").addEventListener("click", async ()=>{
    const text=document.getElementById("searchInput").value.trim().toLowerCase();
    if(!text){ resultsDiv.innerHTML="<p class='muted'>Enter a name or NIA.</p>"; return; }
    resultsDiv.innerHTML="<p class='muted'>Searching...</p>";

    if(!(await deductSearch())){ resultsDiv.innerHTML="<p class='muted'>Please upgrade or use wallet.</p>"; return; }

    updateUI(await loadUser());

    const docs = await getDocs(collection(db,"records"));
    let found=[];
    docs.forEach(docSnap=>{ const r=docSnap.data(); if(r.name?.toLowerCase()===text||r.nia?.toLowerCase()===text) found.push(r); });
    if(found.length===0){ resultsDiv.innerHTML="❌ No record found."; return; }

    resultsDiv.innerHTML="";
    found.forEach(r=>{
      resultsDiv.innerHTML+=`
        <div class="record">
          <h3>${r.name}</h3>
          <p><b>NIA:</b> ${r.nia}</p>
          <p><b>DOB:</b> ${r.dob}</p>
          <p><b>Region:</b> ${r.region}</p>
          <p><b>Address:</b> ${r.address}</p>
          <p><b>Criminal:</b> ${r.criminal}</p>
          <p><b>Driving:</b> ${r.driving}</p>
          <p><b>Credit:</b> ${r.credit}</p>
          <p><b>Status:</b> ${r.status}</p>
        </div>`;
    });

    // LOG SEARCH
    await addDoc(collection(db,"search_logs"),{term:text,timestamp:new Date(),platform:"web",user:userId});
  });

  // WALLET BUTTON
  document.getElementById("walletPageBtn").onclick = ()=>window.location.href="wallet.html";

  // BUY BASIC
  document.getElementById("buyBasicBtn").onclick = async ()=>{
    await updateDoc(userRef,{plan:"basic",monthlyRemaining:10,planExpires:new Date(Date.now()+30*24*60*60*1000)});
    alert("BASIC plan activated: 10 searches this month!");
  };

  // BUY PRO
  document.getElementById("buyProBtn").onclick = async ()=>{
    await updateDoc(userRef,{plan:"pro",monthlyRemaining:9999,planExpires:new Date(Date.now()+30*24*60*60*1000)});
    alert("PRO plan activated: Unlimited searches for 30 days!");
  };

  // USE WALLET
  document.getElementById("useWalletBtn").onclick = async ()=>{
    const bal = await loadWallet();
    if(bal<30){ alert("Not enough balance in wallet."); return; }
    await updateDoc(walletRef,{balance:bal-30});
    await addDoc(collection(db,"search_logs"),{term:"wallet search",timestamp:new Date(),platform:"wallet",user:userId});
    alert("¢30 deducted from wallet. You can now search!");
    updateWalletUI();
  };

  // LIVE UPDATES
  onSnapshot(userRef,(snap)=>{ updateUI(snap.data()); });
  onSnapshot(walletRef,(snap)=>{ updateWalletUI(); });
}

main();
</script>
</body>
</html>
