<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NBVS — Verify</title>

<style>
:root{--red:#ce1126;--yellow:#fcd116;--green:#006b3f;--bg:#f6f7f9;--muted:#555}
body{font-family:"Segoe UI",Arial,sans-serif;background:var(--bg);margin:0;color:#222}
header{background:linear-gradient(90deg,var(--red),var(--yellow),var(--green));
padding:18px;text-align:center;color:#fff;font-weight:700}
main{max-width:900px;margin:18px auto;padding:0 16px}
.panel{background:#fff;padding:16px;border-radius:10px;
box-shadow:0 6px 20px rgba(0,0,0,0.06);margin-bottom:16px}
label{display:block;font-size:0.9rem;color:var(--muted);margin-bottom:6px}
input{width:100%;padding:12px;border-radius:8px;border:1px solid #ccc;
margin-bottom:12px;font-size:1rem}
button{padding:12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
.btn-green{background:var(--green);color:#fff}
.btn-yellow{background:var(--yellow);color:#111}
.btn-red{background:#ce1126;color:#fff}
.record{background:#fff;border-left:5px solid var(--green);padding:12px;
border-radius:8px;margin-top:12px}
.small{font-size:.9rem;color:var(--muted)}
.row{display:flex;gap:12px;margin-top:12px}
.badge{
  display:inline-block;
  padding:3px 10px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,0.12);
  background:#f3f4f6;
  font-size:0.8rem;
  margin-left:8px;
}
.badge-ok{background:#ecfdf5;border-color:rgba(0,107,63,0.25);color:#065f46}
.badge-warn{background:#fff7ed;border-color:rgba(234,88,12,0.25);color:#9a3412}
.badge-bad{background:#fef2f2;border-color:rgba(220,38,38,0.25);color:#991b1b}
</style>
</head>

<body>
<header><h1>NBVS — Admissions & Credential Verification</h1></header>

<main id="app" style="display:none">
  <div class="panel">

    <label for="searchInput">Search by applicant name or ID (NIA / Applicant ID)</label>
    <input id="searchInput" placeholder="e.g. Ama Serwaa or GHA-2039485" />

    <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
      <div class="small" id="planLabel">Plan: —</div>
      <div class="small" id="walletLabel" style="margin-left:auto">Balance: ¢—</div>
    </div>

    <div class="row">
      <button id="searchBtn" class="btn-green" style="flex:1">Start Verification</button>
      <button id="openWallet" class="btn-yellow" style="width:160px">Open Wallet</button>
    </div>

    <p class="small" style="margin-top:10px">
      This verification is consent-based. Results are shown to authorized staff only and audit-logged.
    </p>
  </div>

  <div id="resultsArea"></div>

  <div class="panel">
    <h3>Plans & Conversion</h3>
    <div style="display:flex;gap:10px;margin-bottom:8px">
      <button id="buyBasic" class="btn-green" style="flex:1">
        Buy BASIC — 10 verifications — $3.99
      </button>
      <button id="buyPro" class="btn-red" style="flex:1">
        Buy PRO — 30 days — $14.99
      </button>
    </div>

    <div style="display:flex;gap:10px">
      <button id="convertWallet" class="btn-yellow" style="flex:1">
        Convert Wallet → Verifications (¢30 each)
      </button>
      <button id="refreshBtn" style="flex:1">Refresh</button>
    </div>

    <p class="small" style="margin-top:8px">
      Conversion uses whole multiples of ¢30; remainder stays in wallet.
    </p>
  </div>
</main>


<script type="module">
/* --------------------------------------------------
   FIREBASE
-------------------------------------------------- */
import {
  initializeApp
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, getDocs, query, where, limit
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyCDh_qL3jiCMHROK0_Soul2Wsv3t3y4wv0",
  authDomain:"nbvs-ghana.firebaseapp.com",
  projectId:"nbvs-ghana",
  storageBucket:"nbvs-ghana.firebasestorage.app",
  messagingSenderId:"702636577113",
  appId:"1:702636577113:web:8369b43a2aa43aeb95fc48"
};

const appFB = initializeApp(firebaseConfig);
const db = getFirestore(appFB);

/* --------------------------------------------------
   CONSTANTS
-------------------------------------------------- */
const SEARCH_COST = 30;
const DEVICE_KEY = "nbvs_deviceId";

let deviceId = localStorage.getItem(DEVICE_KEY);
if (!deviceId){
  deviceId = "dev_" + Math.random().toString(36).slice(2,12);
  localStorage.setItem(DEVICE_KEY, deviceId);
}

const walletRef = doc(db, "wallet", deviceId);

const appEl        = document.getElementById("app");
const searchInput  = document.getElementById("searchInput");
const searchBtn    = document.getElementById("searchBtn");
const openWallet   = document.getElementById("openWallet");
const planLabel    = document.getElementById("planLabel");
const walletLabel  = document.getElementById("walletLabel");
const resultsArea  = document.getElementById("resultsArea");
const buyBasic     = document.getElementById("buyBasic");
const buyPro       = document.getElementById("buyPro");
const convertWallet= document.getElementById("convertWallet");
const refreshBtn   = document.getElementById("refreshBtn");

function toNum(n){ return Number(n) || 0; }

/* --------------------------------------------------
   WALLET INIT (UNIFIED FIELDS)
-------------------------------------------------- */
async function ensureWallet(){
  const snap = await getDoc(walletRef);
  if (!snap.exists()){
    await setDoc(walletRef,{
      balance:0,
      plan:"none",          // "none" | "basic" | "pro"
      monthlyRemaining:0,   // basic credits
      planExpires:null,     // ISO string for PRO
      createdAt:new Date()
    });
  } else {
    const u = snap.data();
    const update = {};
    if (u.balance === undefined)           update.balance = 0;
    if (!u.plan)                           update.plan = "none";
    if (u.monthlyRemaining === undefined)  update.monthlyRemaining = 0;
    if (u.planExpires === undefined)       update.planExpires = null;
    if (Object.keys(update).length) await updateDoc(walletRef, update);
  }
}

async function loadWallet(){
  const snap = await getDoc(walletRef);
  return snap.exists() ? snap.data() : null;
}

function formatPlanLabel(u){
  const plan = u.plan || "none";
  if (plan === "pro" && u.planExpires){
    const exp = new Date(u.planExpires);
    return `Plan: PRO (until ${exp.toLocaleDateString()})`;
  }
  if (plan === "basic"){
    return `Plan: BASIC (${toNum(u.monthlyRemaining)} credits left)`;
  }
  return "Plan: none";
}

async function refreshUI(){
  const u = await loadWallet();
  if (!u) return;

  planLabel.innerText   = formatPlanLabel(u);
  walletLabel.innerText = `Balance: ¢${toNum(u.balance)}`;

  appEl.style.display = "block";
}

/* --------------------------------------------------
   DEDUCTION LOGIC  (PRO → BASIC → WALLET)
-------------------------------------------------- */
async function deductSearch(){
  const snap = await getDoc(walletRef);
  if (!snap.exists()) return false;

  const u = snap.data();
  const now = new Date();

  // 1) PRO PLAN (unlimited until expiry, but we log usage)
  if (u.plan === "pro" && u.planExpires){
    const exp = new Date(u.planExpires);
    if (exp > now){
      await addDoc(collection(db,"wallet_transactions"),{
        deviceId,
        type:"verification (pro plan)",
        amount:0,
        timestamp:new Date()
      });
      return true;
    }
  }

  // 2) BASIC CREDITS
  if (toNum(u.monthlyRemaining) > 0){
    await updateDoc(walletRef,{
      monthlyRemaining: toNum(u.monthlyRemaining) - 1,
      plan: "basic"
    });
    await addDoc(collection(db,"wallet_transactions"),{
      deviceId,
      type:"verification (basic credits)",
      amount:0,
      timestamp:new Date()
    });
    return true;
  }

  // 3) WALLET BALANCE
  if (toNum(u.balance) >= SEARCH_COST){
    await updateDoc(walletRef,{ balance: toNum(u.balance) - SEARCH_COST });

    await addDoc(collection(db,"wallet_transactions"),{
      deviceId,
      type:"verification (wallet deduction)",
      amount:-SEARCH_COST,
      timestamp:new Date()
    });

    return true;
  }

  return false;
}

/* --------------------------------------------------
   SEARCH ENGINE (records collection unchanged)
-------------------------------------------------- */
async function performSearch(term){
  const out = [];
  const trimmed = term.trim();
  if (!trimmed) return out;

  const recordsRef = collection(db,"records");

  // ID exact match (NIA / applicant ID stored in `nia`)
  const snapNia = await getDocs(
    query(recordsRef, where("nia","==", trimmed), limit(50))
  );
  snapNia.forEach(d=> out.push(d));

  // Lowercase name match
  const lower = trimmed.toLowerCase();
  const snapName = await getDocs(
    query(recordsRef, where("name_lower","==", lower), limit(200))
  );
  snapName.forEach(d=>{
    if (!out.find(x=>x.id===d.id)) out.push(d);
  });

  // Fallback: scan subset by digits
  const snapAll = await getDocs(query(recordsRef, limit(500)));
  const digits = trimmed.replace(/\D/g,'');

  snapAll.forEach(d=>{
    const r = d.data();

    if ((r.name || "").toLowerCase() === lower)
      if (!out.find(x=>x.id===d.id)) out.push(d);

    if (digits && (r.nia||"").replace(/\D/g,'') === digits)
      if (!out.find(x=>x.id===d.id)) out.push(d);
  });

  return out;
}

function statusBadge(statusRaw){
  const s = String(statusRaw || "").toLowerCase().trim();
  if (!s) return `<span class="badge">Pending</span>`;
  if (["verified","approved","valid","clear"].includes(s)) return `<span class="badge badge-ok">Verified</span>`;
  if (["needs review","review","flagged"].includes(s)) return `<span class="badge badge-warn">Needs review</span>`;
  if (["rejected","invalid","not verified","denied"].includes(s)) return `<span class="badge badge-bad">Not verified</span>`;
  return `<span class="badge">${statusRaw}</span>`;
}

function safe(v){ return (v === undefined || v === null) ? "" : String(v); }

function renderResults(list){
  resultsArea.innerHTML = "";
  if (!list.length){
    resultsArea.innerHTML = `<p class="small">No matching applicant record found.</p>`;
    return;
  }

  list.forEach(d=>{
    const r = d.data();
    const div = document.createElement("div");
    div.className="record";

    // Map to admissions-safe display fields.
    // We keep your existing Firestore fields but do not present "criminal/driving/credit" on the UI.
    const name    = safe(r.name);
    const idVal   = safe(r.nia);
    const dob     = safe(r.dob);
    const region  = safe(r.region);
    const address = safe(r.address);

    // Optional admissions-related fields (if you add them later):
    const program = safe(r.program || r.course || r.department);
    const school  = safe(r.school || r.institution);
    const docs    = safe(r.docs || r.documents || r.attachments);

    div.innerHTML = `
      <p><b>Applicant:</b> ${name} ${statusBadge(r.status)}</p>
      <p><b>ID:</b> ${idVal}</p>
      ${dob ? `<p><b>DOB:</b> ${dob}</p>` : ``}
      ${region ? `<p><b>Region:</b> ${region}</p>` : ``}
      ${address ? `<p><b>Address:</b> ${address}</p>` : ``}

      ${program ? `<p><b>Program:</b> ${program}</p>` : ``}
      ${school ? `<p><b>Institution:</b> ${school}</p>` : ``}
      ${docs ? `<p><b>Documents:</b> ${docs}</p>` : ``}

      <p class="small" style="margin-top:8px">
        Note: Results reflect submitted documents and staff review within NBVS.
      </p>
    `;
    resultsArea.appendChild(div);
  });
}

/* --------------------------------------------------
   SEARCH BUTTON
-------------------------------------------------- */
searchBtn.onclick = async () => {
  const term = searchInput.value.trim();
  if (!term){
    resultsArea.innerHTML = `<p class="small">Enter a name or ID.</p>`;
    return;
  }

  resultsArea.innerHTML = `<p class="small">Checking plan…</p>`;

  const ok = await deductSearch();
  if (!ok){
    resultsArea.innerHTML = `<p class="small">Not enough credits. Top up wallet or buy a plan.</p>`;
    await refreshUI();
    return;
  }

  await refreshUI();
  resultsArea.innerHTML = `<p class="small">Searching…</p>`;

  const docs = await performSearch(term);
  renderResults(docs);

  await addDoc(collection(db,"search_logs"),{
    term,
    deviceId,
    found: docs.length>0,
    timestamp:new Date()
  });
};

/* --------------------------------------------------
   WALLET, BASIC, PRO, CONVERSION
-------------------------------------------------- */
openWallet.onclick = ()=> window.location.href = "wallet.html";

buyBasic.onclick = async ()=>{
  const snap = await getDoc(walletRef);
  const u = snap.data() || {};

  await updateDoc(walletRef,{
    plan:"basic",
    monthlyRemaining: toNum(u.monthlyRemaining) + 10
  });

  await addDoc(collection(db,"wallet_transactions"),{
    deviceId,
    type:"buy_basic_plan (+10 verifications)",
    amount:0,
    timestamp:new Date()
  });

  alert("Basic activated: +10 verifications");
  await refreshUI();
};

buyPro.onclick = async ()=>{
  const exp = new Date(Date.now() + 30*24*60*60*1000);

  await updateDoc(walletRef,{
    plan:"pro",
    planExpires: exp.toISOString()
  });

  await addDoc(collection(db,"wallet_transactions"),{
    deviceId,
    type:"buy_pro_plan (30 days)",
    amount:0,
    timestamp:new Date()
  });

  alert("Pro plan activated (30 days unlimited)");
  await refreshUI();
};

convertWallet.onclick = async ()=>{
  const snap = await getDoc(walletRef);
  const u = snap.data();

  const bal = toNum(u.balance);
  if (bal < SEARCH_COST) return alert("Not enough balance to convert.");

  const searches = Math.floor(bal / SEARCH_COST);
  const spent = searches * SEARCH_COST;

  await updateDoc(walletRef,{
    balance: bal - spent,
    monthlyRemaining: toNum(u.monthlyRemaining) + searches,
    plan: u.plan === "none" ? "basic" : u.plan
  });

  await addDoc(collection(db,"wallet_transactions"),{
    deviceId,
    type:"convert_wallet_to_verifications",
    amount:-spent,
    timestamp:new Date()
  });

  alert(`Converted ¢${spent} → ${searches} verifications`);
  await refreshUI();
};

refreshBtn.onclick = async ()=>{
  resultsArea.innerHTML="";
  await refreshUI();
};

/* --------------------------------------------------
   INIT
-------------------------------------------------- */
(async()=>{
  await ensureWallet();
  await refreshUI();
})();
</script>

</body>
</html>
