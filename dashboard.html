<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>NBVS Admin Login</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:40px;background:#f7f7f7}
    .card{max-width:420px;margin:40px auto;padding:24px;background:#fff;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
    input{width:100%;padding:10px;margin:8px 0;border:1px solid #ddd;border-radius:6px}
    button{width:100%;padding:10px;background:#006b3f;color:#fff;border:none;border-radius:6px;cursor:pointer}
    .note{font-size:13px;color:#666;margin-top:12px}
  </style>
</head>
<body>
  <div class="card">
    <h2>NBVS Admin Login</h2>
    <input id="email" placeholder="Email" autocomplete="username" />
    <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
    <button id="btn-login">Sign in</button>
    <div class="note" id="login-note"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { 
      getAuth, signInWithEmailAndPassword, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import { 
      getFirestore, doc, getDoc 
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCDh_qL3jiCMHROK0_Soul2Wsv3t3y4wv0",
      authDomain: "nbvs-ghana.firebaseapp.com",
      projectId: "nbvs-ghana",
      storageBucket: "nbvs-ghana.firebasestorage.app",
      messagingSenderId: "702636577113",
      appId: "1:702636577113:web:8369b43a2aa43aeb95fc48",
      measurementId: "G-2FHFSQRMZX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const emailEl = document.getElementById("email");
    const passEl  = document.getElementById("password");
    const noteEl  = document.getElementById("login-note");
    const btn     = document.getElementById("btn-login");


    /* ============================================================
       LOGIN BUTTON
    ============================================================ */
    btn.addEventListener("click", async () => {
      noteEl.textContent = "";
      const email = emailEl.value.trim();
      const pwd   = passEl.value.trim();

      if (!email || !pwd) {
        noteEl.textContent = "Enter email and password.";
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, email, pwd);
        // Redirect handled below
      } catch (err) {
        console.error(err);
        noteEl.textContent = (err?.code || err?.message) || "Login failed.";
      }
    });



    /* ============================================================
       GLOBAL ROLE-BASED REDIRECT  
       (ONLY PLACE IN YOUR ENTIRE APP WHERE REDIRECT DECISIONS HAPPEN)
    ============================================================ */
    onAuthStateChanged(auth, async (user) => {
      if (!user) return;  // not logged in â†’ stay on login page

      let udoc;
      try {
        udoc = await getDoc(doc(db, "users", user.uid));
      } catch (e) {
        console.error(e);
        noteEl.textContent = "Error reading user record.";
        return;
      }

      if (!udoc.exists()) {
        noteEl.textContent = "No user record found.";
        return;
      }

      const role = (udoc.data().role || "").toLowerCase();

      // ========= ADMIN / STAFF / SUPERADMIN =========
      if (role === "admin" || role === "staff" || role === "superadmin") {
        return window.location.href = "admin.html";
      }

      // ========= EMPLOYER =========
      if (role === "employer") {
        return window.location.href = "employer.html";
      }

      // ========= USER =========
      if (role === "user") {
        return window.location.href = "user.html";
      }

      // ========= UNKNOWN ROLE =========
      noteEl.textContent = "You do not have a valid NBVS role.";
      await auth.signOut();
    });
  </script>
</body>
</html>
