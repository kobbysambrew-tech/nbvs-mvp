<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NBVS Admin â€” Full Dashboard</title>

<!-- Styles (kept compact) -->
<style>
:root{
  --red:#ce1126;
  --yellow:#fcd116;
  --green:#006b3f;
  --accent:#004f2e;
  --bg:#f5f6f8;
  --card:#ffffff;
  --muted:#6b7280;
  --shadow-sm:0 2px 6px rgba(0,0,0,0.08);
  --shadow:0 4px 16px rgba(0,0,0,0.10);
  --shadow-lg:0 8px 24px rgba(0,0,0,0.16);
}

*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  font-family:"Segoe UI",Arial,sans-serif;
}
body{
  background:var(--bg);
  color:#1f2937;
}

header{
  background:linear-gradient(90deg,var(--red),var(--yellow),var(--green));
  padding:1.4rem 1rem 1rem;
  text-align:center;
  color:#fff;
  box-shadow:var(--shadow);
}
header h1{
  font-size:1.5rem;
  font-weight:700;
}
#admin-role{
  display:inline-block;
  background:rgba(255,255,255,0.15);
  padding:3px 10px;
  border-radius:6px;
  margin-top:4px;
}

#btn-logout{
  float:right;
  padding:6px 12px;
  background:#fff;
  color:#222;
  border-radius:6px;
  font-weight:600;
  border:none;
  cursor:pointer;
  transition:0.2s;
}
#btn-logout:hover{
  transform:translateY(-1px);
}

main{
  max-width:1100px;
  margin:1.4rem auto;
  padding:0 14px;
}

.tabs{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:14px;
}
.tabs button{
  flex:1;
  border-radius:10px;
  padding:10px 0;
  border:none;
  background:#ffffff;
  box-shadow:var(--shadow-sm);
  font-weight:600;
  cursor:pointer;
  transition:0.2s;
}
.tabs button.active{
  background:var(--green);
  color:#fff;
}

.panel{
  background:var(--card);
  border-radius:12px;
  padding:16px;
  box-shadow:var(--shadow);
  margin-bottom:16px;
}

/* Smaller UI rules unchanged */
h3{ margin-bottom:10px;font-size:1.1rem; }
input,select,textarea{
  width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;margin-bottom:8px;
}
.btn{ padding:10px 14px; border-radius:8px; border:none; font-weight:600; cursor:pointer; }
.btn-green{ background:var(--green); color:#fff; }
.btn-red{ background:var(--red); color:#fff; }
.btn-yellow{ background:var(--yellow); color:#222; }

.table{ width:100%; border-collapse:collapse; }
.table th{ background:#f1f5f9; padding:10px; font-weight:700; }
.table td{ padding:10px; border-bottom:1px solid #e5e7eb; }

.record{
  background:#fff;
  border-left:5px solid var(--green);
  padding:12px;
  border-radius:10px;
  box-shadow:var(--shadow-sm);
  margin-bottom:10px;
}
.small{ font-size:0.82rem; color:var(--muted); }

</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header>
  <h1>NBVS Admin â€” Full Dashboard</h1>
  <div style="margin-top:6px">
    <span id="admin-role" class="small">Loading roleâ€¦</span>
    <button id="btn-logout">Logout</button>
  </div>
</header>

<main>
  <div class="tabs">
    <button id="tab-dashboard" class="active">Dashboard</button>
    <button id="tab-verify">Verify</button>
    <button id="tab-records">Records</button>
    <button id="tab-users">Users</button>
    <button id="tab-wallet">Wallet</button>
    <button id="tab-logs">Search Logs</button>
    <button id="tab-audit">Audit Logs</button>
    <button id="tab-analytics">Analytics</button>
    <button id="tab-tools">Tools</button>
    <button id="tab-apikeys">API Keys</button>
  </div>

  <!-- DASHBOARD -->
  <section id="section-dashboard" class="active">
    <div class="panel">
      <h3>Overview</h3>
      <div class="flex" style="gap:24px;">
        <div><div class="kv">Users</div><div id="stat-users">â€”</div></div>
        <div><div class="kv">Searches</div><div id="stat-searches">â€”</div></div>
        <div><div class="kv">Wallet total</div><div id="stat-wallet">â€”</div></div>
        <div><div class="kv">Transactions</div><div id="stat-transactions">â€”</div></div>
      </div>
    </div>
    <div class="panel" id="analytics-charts"><p class="small">Analytics loadingâ€¦</p></div>
  </section>

  <!-- VERIFY -->
  <section id="section-verify" style="display:none">
    <div class="panel">
      <h3>Verify (Admin)</h3>
      <input id="verify-query" placeholder="Full name or NIA" />

      <div class="flex" style="margin-top:6px">
        <button id="verify-search" class="btn btn-green">Search</button>
        <button id="verify-search-nia" class="btn btn-yellow">Search NIA</button>
        <button id="verify-clear" class="btn">Clear</button>
      </div>

      <div id="verify-results" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- RECORDS -->
  <section id="section-records" style="display:none">
    <div class="panel">
      <h3>Create / Edit Record</h3>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <input id="rec-name" placeholder="Name" />
        <input id="rec-nia" placeholder="NIA" />
        <input id="rec-dob" placeholder="DOB (YYYY-MM-DD)" />
        <input id="rec-region" placeholder="Region" />
        <input id="rec-address" placeholder="Address" />
        <input id="rec-credit" placeholder="Credit score" />
        <input id="rec-criminal" placeholder="Criminal status" />
        <input id="rec-driving" placeholder="Driving status" />
        <input id="rec-status" placeholder="Verification status" />
      </div>

      <div style="display:flex;gap:8px;margin-top:8px;">
        <button id="rec-create" class="btn btn-green">Add Record</button>
        <button id="rec-update" class="btn btn-yellow">Update Record</button>
        <button id="rec-clear" class="btn">Clear</button>

        <div style="flex:1"></div>

        <input id="rec-id" placeholder="Record ID" style="width:240px" />
        <button id="rec-delete" class="btn btn-red">Delete</button>
      </div>

      <div id="rec-output" class="small" style="margin-top:6px"></div>
    </div>

    <div class="panel">
      <h3>Records Browser</h3>
      <div style="display:flex;gap:8px">
        <input id="records-filter" placeholder="Filter by name or region..." />
        <button id="records-refresh" class="btn">Refresh</button>
      </div>
      <div id="records-list" style="margin-top:8px">Loadingâ€¦</div>
    </div>
  </section>

  <!-- USERS -->
  <section id="section-users" style="display:none">
    <div class="panel">
      <h3>Manage Users</h3>

      <div style="display:flex;gap:8px">
        <input id="new-user-email" placeholder="Email" />
        <input id="new-user-name" placeholder="Name" />
        <select id="new-user-role">
          <option value="user">user</option>
          <option value="staff">staff</option>
          <option value="superadmin">superadmin</option>
        </select>
        <button id="create-user" class="btn btn-green">Create User</button>
      </div>

      <div class="small" style="margin-top:6px">
        Creates the Firestore doc.  
        Staff cannot access this screen.
      </div>
    </div>

    <div class="panel">
      <h3>Users</h3>

      <table class="table" id="users-table">
        <thead>
          <tr><th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr>
        </thead>
        <tbody id="users-tbody">
          <tr><td colspan="5">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- WALLET -->
  <section id="section-wallet" style="display:none">
    <div class="panel">
      <h3>Wallet Balances</h3>

      <table class="table" id="wallet-table">
        <thead><tr><th>User</th><th>Balance</th><th>Action</th></tr></thead>
        <tbody id="wallet-tbody">
          <tr><td colspan="3">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </div>

    <div class="panel">
      <h3>Transactions</h3>
      <table class="table" id="wallettx-table">
        <thead><tr><th>Time</th><th>User</th><th>Type</th><th>Amount</th></tr></thead>
        <tbody id="wallettx-tbody">
          <tr><td colspan="4">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- SEARCH LOGS -->
  <section id="section-logs" style="display:none">
    <div class="panel">
      <h3>Search Logs</h3>
      <table class="table" id="searchlogs-table">
        <thead><tr><th>Time</th><th>User</th><th>Query</th><th>Found</th></tr></thead>
        <tbody id="searchlogs-tbody">
          <tr><td colspan="4">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- AUDIT LOGS -->
  <section id="section-audit" style="display:none">
    <div class="panel">
      <h3>Audit Logs</h3>
      <table class="table" id="auditlogs-table">
        <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Meta</th></tr></thead>
        <tbody id="auditlogs-tbody">
          <tr><td colspan="4">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- ANALYTICS -->
  <section id="section-analytics" style="display:none">
    <div class="panel">
      <h3>Analytics</h3>
      <canvas id="chart-searches" style="max-height:240px"></canvas>
      <canvas id="chart-wallet" style="max-height:240px;margin-top:12px"></canvas>
      <canvas id="chart-users" style="max-height:240px;margin-top:12px"></canvas>
    </div>
  </section>

  <!-- TOOLS -->
  <section id="section-tools" style="display:none">
    <div class="panel">
      <h3>Tools & Add-ons</h3>

      <div style="display:flex;gap:8px;">
        <input id="csv-upload" type="file" class="file-input" accept=".csv" />
        <button id="csv-import" class="btn">Import CSV</button>
        <button id="export-csv" class="btn">Export CSV</button>
      </div>

      <div style="margin-top:8px;display:flex;gap:8px;">
        <button id="export-pdf" class="btn">Export Record PDF</button>
        <button id="face-match" class="btn">Face Match (stub)</button>
        <button id="manage-api" class="btn">API Keys (stub)</button>
      </div>
    </div>
  </section>

  <!-- API KEYS -->
  <section id="section-apikeys" style="display:none">
    <div class="panel">
      <h3>API Keys (Companies)</h3>

      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px;">
        <input id="api-company" placeholder="Company name (e.g. Zenith Bank)" />
        <input id="api-email" placeholder="Contact email (optional)" />
        <input id="api-limit" type="number" min="1" placeholder="Daily limit (e.g. 1000)" />
      </div>

      <button id="api-create" class="btn btn-green">Generate API Key</button>
      <p class="small" style="margin-top:6px;">
        Superadmin only. Keys are for companies that want to integrate NBVS via API.
      </p>
    </div>

    <div class="panel">
      <h3>Existing API Keys</h3>
      <table class="table">
        <thead>
          <tr>
            <th>Key</th>
            <th>Company</th>
            <th>Status</th>
            <th>Usage</th>
            <th>Last Used</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="api-keys-tbody">
          <tr><td colspan="6">Loadingâ€¦</td></tr>
        </tbody>
      </table>
      <p class="small" style="margin-top:6px;">
        Usage = usedToday / dailyLimit. Reset happens automatically once per day in your API backend.
      </p>
    </div>
  </section>

</main>

<script type="module">
/* ============================================================
   NBVS ADMIN JS â€” FIXED ACCESS CONTROL + NO REDIRECT LOOPS
   ============================================================ */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import {
  getFirestore, collection, doc, getDoc, getDocs, query, where,
  addDoc, updateDoc, deleteDoc, orderBy, limit
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
import { getAnalytics, isSupported as analyticsSupported } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-analytics.js";

const firebaseConfig = {
  apiKey:"AIzaSyCDh_qL3jiCMHROK0_Soul2Wsv3t3y4wv0",
  authDomain:"nbvs-ghana.firebaseapp.com",
  projectId:"nbvs-ghana",
  storageBucket:"nbvs-ghana.firebasestorage.app",
  messagingSenderId:"702636577113",
  appId:"1:702636577113:web:8369b43a2aa43aeb95fc48",
  measurementId:"G-2FHFSQRMZX"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let analytics;
(async()=>{ if(await analyticsSupported()) analytics = getAnalytics(app); })();

let currentUser = null;
let currentUserRole = null;


/* ============================================================
   AUTH + ROLE CHECK (SUPER IMPORTANT FIX)
   ============================================================ */
onAuthStateChanged(auth, async (user) => {

  // not logged in â†’ redirect to login page
  if (!user) return window.location.href = "dashboard.html";

  const uDoc = await getDoc(doc(db,"users",user.uid));

  if (!uDoc.exists()) {
    await signOut(auth);
    return window.location.href = "dashboard.html";
  }

  const role = (uDoc.data().role || "").toLowerCase();
  currentUser = user;
  currentUserRole = role;

  document.getElementById("admin-role").innerText = role;

  // ðŸ”¥ ONLY LET THESE ROLES CONTINUE
  if (role !== "admin" && role !== "staff" && role !== "superadmin") {
    alert("Access denied. Admin only.");
    await signOut(auth);
    return window.location.href = "dashboard.html";
  }

  // If they are allowed â†’ load dashboard normally
  setupTabs();
  setupButtons();

  setTimeout(async () => {
    applyRoleRestrictions();
    await refreshAll();
  }, 300);
});


/* ============================================================
   LOGOUT
   ============================================================ */
document.getElementById("btn-logout").onclick = async () => {
  await signOut(auth);
  window.location.href = "dashboard.html";
};


/* ============================================================
   ROLE RESTRICTIONS FOR STAFF
   ============================================================ */
function applyRoleRestrictions() {
  if (currentUserRole !== "staff") return;

  document.getElementById("tab-users").style.display = "none";
  document.getElementById("tab-audit").style.display = "none";
  document.getElementById("tab-tools").style.display = "none";
  document.getElementById("tab-apikeys").style.display = "none";

  document.getElementById("section-tools").style.display = "none";
  document.getElementById("section-apikeys").style.display = "none";

  const userPanel = document.querySelector("#section-users .panel");
  if (userPanel) userPanel.style.display = "none";

  const style = document.createElement("style");
  style.innerHTML = `
    button[data-delete],
    button[data-promote],
    #rec-delete,
    button[data-action="add"],
    button[data-action="set"] {
      display: none !important;
    }
  `;
  document.head.appendChild(style);
}


/* ============================================================
   TABS + BUTTONS (unchanged)
   ============================================================ */

function setupTabs(){ /* unchanged */ }
function setupButtons(){ /* unchanged */ }

/* ============================================================
   EVERYTHING ELSE (unchanged)
   ============================================================ */

async function adminVerifySearch(){ /* unchanged */ }
async function createRecord(){ /* unchanged */ }
async function updateRecordById(){ /* unchanged */ }
async function deleteRecordById(){ /* unchanged */ }
async function loadRecordsList(){ /* unchanged */ }
async function loadRecordIntoForm(){ /* unchanged */ }
async function createUserDoc(){ /* unchanged */ }
async function loadUsersTable(){ /* unchanged */ }
async function loadUserSearchLogs(){ /* unchanged */ }
async function loadWallets(){ /* unchanged */ }
async function promptAddWallet(){ /* unchanged */ }
async function promptSetWallet(){ /* unchanged */ }
async function loadWalletTxs(){ /* unchanged */ }
async function loadSearchLogs(){ /* unchanged */ }
async function loadAuditLogs(){ /* unchanged */ }
async function createApiKey(){ /* unchanged */ }
async function loadApiKeys(){ /* unchanged */ }
async function toggleApiKeyStatus(){ /* unchanged */ }
async function resetApiUsage(){ /* unchanged */ }
async function deleteApiKey(){ /* unchanged */ }
async function renderAnalytics(){ /* unchanged */ }
async function refreshAll(){ /* unchanged */ }

window.loadRecordsList = loadRecordsList;

</script>

</script>
</body>
</html>
