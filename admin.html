<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NBVS Admin Dashboard</title>

  <style>
    :root{
      --green:#006b3f;
      --yellow:#fcd116;
      --red:#ce1126;
      --bg:#f8f9fa;
      --card:#ffffff;
      --muted:#666;
      --maxw:1200px;
    }
    body{
      font-family:"Segoe UI",Arial,sans-serif;
      background:var(--bg);
      margin:0;
      padding:20px;
      display:flex;
      justify-content:center;
    }
    .container{max-width:var(--maxw);width:100%}
    h1{color:var(--green);text-align:center;margin-bottom:18px}

    .panel{
      background:var(--card);
      padding:18px;
      border-radius:10px;
      box-shadow:0 3px 8px rgba(0,0,0,0.06);
      margin-bottom:16px;
    }

    input,select{
      width:100%;
      padding:10px;
      border-radius:6px;
      border:1px solid #ddd;
      margin-top:8px;
    }

    button{
      padding:10px 14px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
    }
    .btn-red{background:var(--red);color:#fff}
    .btn-yellow{background:var(--yellow);color:#111}
    .btn-green{background:var(--green);color:#fff}
    .secondary{background:#f4f4f4;color:#111;border:1px solid #ccc}

    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    th{background:var(--green);color:#fff;position:sticky;top:0}

    .actions button{margin-right:4px}
    .pagination{display:flex;gap:8px;justify-content:center;margin-top:12px}

    .muted{color:var(--muted);font-size:.9rem}

    /* Header Bar */
    .admin-top{
      width:100%;
      background:var(--green);
      color:white;
      padding:14px 20px;
      border-radius:10px;
      margin-bottom:20px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }

    .top-buttons button{
      padding:8px 14px;
      border-radius:8px;
      font-weight:600;
      cursor:pointer;
    }
    .btn-nav-yellow{background:var(--yellow);color:#111}
    .btn-nav-white{background:white;color:var(--green)}
    .btn-nav-red{background:var(--red);color:white}

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.45);
      display:none;
      align-items:center;
      justify-content:center;
    }
    .modal{
      background:#fff;
      padding:18px;
      border-radius:10px;
      max-width:720px;
      width:100%;
      box-shadow:0 10px 30px rgba(0,0,0,0.2)
    }

    @media(max-width:880px){
      .admin-top{flex-direction:column;gap:12px}
    }
  </style>
</head>

<body>

<!-- ✅ ADMIN HEADER BAR -->
<div class="admin-top">
  <div style="font-size:1.2rem;font-weight:700">⚙️ NBVS Admin Panel — Welcome, Admin Aubrey</div>

  <div class="top-buttons">
    <button class="btn-nav-yellow" onclick="scrollToRecords()">Records</button>
    <button class="btn-nav-white" onclick="scrollToAnalytics()">Analytics</button>
    <button class="btn-nav-red" onclick="logout()">Logout</button>
  </div>
</div>

<script>
function logout(){
  window.location.href = "dashboard.html";
}
function scrollToRecords(){
  document.getElementById("recordsSection").scrollIntoView({behavior:"smooth"});
}
function scrollToAnalytics(){
  document.getElementById("analyticsTable").scrollIntoView({behavior:"smooth"});
}
</script>

<div class="container">

  <h1>NBVS Admin Dashboard</h1>

  <!-- ✅ BULK IMPORT -->
  <div class="panel">
    <h3>Bulk Import (CSV)</h3>
    <p class="muted">Columns: name, nia, dob, region, address, criminal, driving, credit, status</p>

    <input type="file" id="csvFile" accept=".csv" />
    <div style="margin-top:10px">
      <button class="btn-green" id="importBtn">Import CSV</button>
      <button class="secondary" id="clearImportBtn">Clear File</button>
    </div>
    <p id="importStatus" class="muted" style="margin-top:8px"></p>
  </div>

  <!-- ✅ ADD RECORD -->
  <div class="panel">
    <h3>Add New Record</h3>

    <div style="display:flex;gap:16px;flex-wrap:wrap">
      <div style="flex:1;min-width:260px">
        <label>Name</label><input id="nameInput"/>
        <label>NIA</label><input id="niaInput"/>
        <label>DOB</label><input id="dobInput"/>
        <label>Region</label><input id="regionInput"/>
      </div>

      <div style="flex:1;min-width:260px">
        <label>Address</label><input id="addressInput"/>
        <label>Criminal</label><input id="criminalInput"/>
        <label>Driving</label><input id="drivingInput"/>
        <label>Credit</label><input id="creditInput"/>
        <label>Status</label>
        <select id="statusInput">
          <option>Verified</option>
          <option>Flagged</option>
          <option>Warning</option>
        </select>

        <button class="btn-green" style="margin-top:10px" id="addBtn">Add Record</button>
      </div>
    </div>
  </div>

  <!-- ✅ RECORDS TABLE -->
  <div class="panel" id="recordsSection">

    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;gap:12px;align-items:center">
        <input type="checkbox" id="selectAll"/>
        <label for="selectAll">Select all</label>

        <button class="btn-red" id="multiDeleteBtn">Delete Selected</button>
        <button class="btn-yellow" id="exportSelectedBtn">Export Selected</button>
        <button class="btn-green" id="downloadCsvBtn">Download All</button>
      </div>

      <div>
        <input id="globalSearch" placeholder="Search name or NIA..." style="padding:8px;width:220px">
        <select id="filterSelect">
          <option value="ALL">All</option>
          <option value="Verified">Verified</option>
          <option value="Flagged">Flagged</option>
          <option value="Warning">Warning</option>
        </select>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th></th>
          <th>Name</th>
          <th>NIA</th>
          <th>Region</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>

      <tbody id="recordsTable"></tbody>
    </table>

    <div class="pagination">
      <button class="secondary" id="prevPageBtn">← Prev</button>
      <button class="secondary" id="nextPageBtn">Next →</button>
    </div>

    <div class="muted" id="pageInfo">Page 1</div>
  </div>

  <!-- ✅ ANALYTICS SECTION -->
  <div class="panel">
    <h2>Analytics — Search Logs</h2>
    <p class="muted">Live tracking of verify searches</p>

    <p><b>Total Searches:</b> <span id="totalLogs">0</span></p>

    <table id="analyticsTable">
      <thead>
        <tr>
          <th>Term</th>
          <th>Platform</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody id="analyticsBody"></tbody>
    </table>
  </div>

</div>

<!-- ✅ MODAL FOR EDITING -->
<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Edit Record</h3>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div>
        <label>Name</label><input id="modal_name"/>
        <label>NIA</label><input id="modal_nia"/>
        <label>DOB</label><input id="modal_dob"/>
        <label>Region</label><input id="modal_region"/>
      </div>
      <div>
        <label>Address</label><input id="modal_address"/>
        <label>Criminal</label><input id="modal_criminal"/>
        <label>Driving</label><input id="modal_driving"/>
        <label>Credit</label><input id="modal_credit"/>
        <label>Status</label>
        <select id="modal_status">
          <option>Verified</option>
          <option>Flagged</option>
          <option>Warning</option>
        </select>
      </div>
    </div>

    <div style="margin-top:10px;display:flex;justify-content:flex-end;gap:10px">
      <button class="secondary" id="modalCancel">Cancel</button>
      <button class="btn-green" id="modalSave">Save</button>
    </div>

  </div>
</div>

<!-- ✅ FIREBASE + FULL JS (records + analytics) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
import {
  getFirestore, collection, doc, addDoc, getDocs, getDoc,
  updateDoc, deleteDoc, query, orderBy, limit, startAfter,
  startAt, where
} from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyCDh_qL3jiCMHROK0_Soul2Wsv3t3y4wv0",
  authDomain:"nbvs-ghana.firebaseapp.com",
  projectId:"nbvs-ghana",
  storageBucket:"nbvs-ghana.firebasestorage.app",
  messagingSenderId:"702636577113",
  appId:"1:702636577113:web:8369b43a2aa43aeb95fc48"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===========================================================
   RECORDS SYSTEM (UNCHANGED — FULLY WORKING)
   =========================================================== */

const recordsRef = collection(db,"records");
const logsRef = collection(db,"search_logs");

const PAGE_SIZE = 10;
let lastVisible = null;
let firstVisible = null;
let currentPage = 1;
let selectedIds = new Set();
let activeFilter = "ALL";
let activeSearch = "";

/* SHORTCUTS */
const recordsTable = document.getElementById("recordsTable");
const analyticsBody = document.getElementById("analyticsBody");
const totalLogs = document.getElementById("totalLogs");

/* CSV UTIL */
function toCSVRow(arr){
  return arr.map(v => `"${String(v??"").replace(/"/g,'""')}"`).join(",");
}
function parseCSV(text){
  return text.split(/\r?\n/)
    .map(l => l.trim())
    .filter(l => l.length)
    .map(line => {
      const regex = /,(?=(?:[^"]*"[^"]*")*[^"]*$)/;
      return line.split(regex).map(p => p.replace(/^"|"$/g,""));
    });
}

/* ===========================================================
   RECORDS — LOADING + RENDERING
   =========================================================== */

function buildQuery(direction="first"){
  let q = query(recordsRef, orderBy("name"), limit(PAGE_SIZE));

  if(activeFilter!=="ALL"){
    q = query(recordsRef,
      where("status","==",activeFilter),
      orderBy("name"),
      limit(PAGE_SIZE)
    );
  }

  if(direction==="next" && lastVisible){
    q = query(recordsRef, orderBy("name"), startAfter(lastVisible), limit(PAGE_SIZE));
  }
  if(direction==="prev" && firstVisible && currentPage>1){
    q = query(recordsRef, orderBy("name"), startAt(firstVisible), limit(PAGE_SIZE));
  }

  return q;
}

async function loadPage(direction="first"){
  const snapshot = await getDocs(buildQuery(direction));

  if(!snapshot.empty){
    firstVisible = snapshot.docs[0];
    lastVisible = snapshot.docs[snapshot.docs.length-1];
  }

  let docs = snapshot.docs;

  if(activeSearch.trim()!==""){
    const s = activeSearch.toLowerCase();
    docs = docs.filter(d=>{
      const v=d.data();
      return v.name.toLowerCase().includes(s) || v.nia.toLowerCase().includes(s);
    });
  }

  renderTable(docs);
  document.getElementById("pageInfo").textContent = `Page ${currentPage}`;
}

function renderTable(docs){
  recordsTable.innerHTML="";
  selectedIds.clear();
  document.getElementById("selectAll").checked=false;

  docs.forEach(docSnap=>{
    const d=docSnap.data();
    const id=docSnap.id;

    recordsTable.innerHTML+=`
      <tr>
        <td><input type="checkbox" class="rowCheckbox" data-id="${id}"></td>
        <td>${d.name}</td>
        <td>${d.nia}</td>
        <td>${d.region}</td>
        <td>${d.status}</td>
        <td>
          <button class="btn-yellow" onclick="openEditModal('${id}')">Edit</button>
          <button class="btn-red" onclick="deleteRecord('${id}')">Delete</button>
        </td>
      </tr>
    `;
  });

  document.querySelectorAll(".rowCheckbox").forEach(cb=>{
    cb.addEventListener("change",e=>{
      const id=e.target.dataset.id;
      if(e.target.checked) selectedIds.add(id);
      else selectedIds.delete(id);
    });
  });
}

/* NEXT/PREV */
document.getElementById("nextPageBtn").onclick=()=>{currentPage++;loadPage("next")};
document.getElementById("prevPageBtn").onclick=()=>{if(currentPage>1){currentPage--;loadPage("prev")}};

/* SELECT ALL */
document.getElementById("selectAll").onchange=e=>{
  const checked=e.target.checked;
  document.querySelectorAll(".rowCheckbox").forEach(cb=>{
    cb.checked=checked;
    if(checked) selectedIds.add(cb.dataset.id);
    else selectedIds.clear();
  });
};

/* FILTER */
document.getElementById("filterSelect").onchange=e=>{
  activeFilter=e.target.value;
  currentPage=1;
  loadPage();
};

/* SEARCH */
document.getElementById("globalSearch").oninput=e=>{
  activeSearch=e.target.value;
  loadPage();
};

/* DELETE MULTI */
document.getElementById("multiDeleteBtn").onclick=async()=>{
  if(selectedIds.size===0) return alert("Nothing selected.");
  if(!confirm("Delete selected?")) return;
  for(const id of selectedIds){
    await deleteDoc(doc(db,"records",id));
  }
  alert("Deleted.");
  loadPage();
};

/* EXPORT SELECTED */
document.getElementById("exportSelectedBtn").onclick=async()=>{
  if(selectedIds.size===0) return alert("Nothing selected.");

  let out=[];
  out.push(toCSVRow(["name","nia","dob","region","address","criminal","driving","credit","status"]));

  for(const id of selectedIds){
    const snap=await getDoc(doc(db,"records",id));
    if(snap.exists()){
      const d=snap.data();
      out.push(toCSVRow([
        d.name,d.nia,d.dob,d.region,d.address,d.criminal,d.driving,d.credit,d.status
      ]));
    }
  }

  const blob=new Blob([out.join("\n")],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="nbvs-selected.csv";
  a.click();
};

/* DOWNLOAD ALL */
document.getElementById("downloadCsvBtn").onclick=async()=>{
  const snaps=await getDocs(recordsRef);
  let out=[];
  out.push(toCSVRow(["name","nia","dob","region","address","criminal","driving","credit","status"]));

  snaps.forEach(docSnap=>{
    const d=docSnap.data();
    out.push(toCSVRow([d.name,d.nia,d.dob,d.region,d.address,d.criminal,d.driving,d.credit,d.status]));
  });

  const blob=new Blob([out.join("\n")],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="nbvs-records-all.csv";
  a.click();
};

/* ADD NEW RECORD */
document.getElementById("addBtn").onclick=async()=>{
  const rec={
    name:nameInput.value.trim(),
    nia:niaInput.value.trim(),
    dob:dobInput.value.trim(),
    region:regionInput.value.trim(),
    address:addressInput.value.trim(),
    criminal:criminalInput.value.trim(),
    driving:drivingInput.value.trim(),
    credit:creditInput.value.trim(),
    status:statusInput.value
  };

  if(!rec.name || !rec.nia) return alert("Name + NIA required");

  await addDoc(recordsRef, rec);
  alert("Added.");
  loadPage();
};

/* DELETE SINGLE */
window.deleteRecord=async(id)=>{
  if(!confirm("Delete?")) return;
  await deleteDoc(doc(db,"records",id));
  loadPage();
};

/* MODAL EDIT */
const modalBackdrop=document.getElementById("modalBackdrop");
let editingId=null;

window.openEditModal=async(id)=>{
  editingId=id;
  const snap=await getDoc(doc(db,"records",id));
  if(!snap.exists()) return alert("Not found");

  const d=snap.data();
  modal_name.value=d.name;
  modal_nia.value=d.nia;
  modal_dob.value=d.dob;
  modal_region.value=d.region;
  modal_address.value=d.address;
  modal_criminal.value=d.criminal;
  modal_driving.value=d.driving;
  modal_credit.value=d.credit;
  modal_status.value=d.status;

  modalBackdrop.style.display="flex";
};

document.getElementById("modalCancel").onclick=()=>{
  modalBackdrop.style.display="none";
  editingId=null;
};

document.getElementById("modalSave").onclick=async()=>{
  if(!editingId) return;

  await updateDoc(doc(db,"records",editingId),{
    name:modal_name.value.trim(),
    nia:modal_nia.value.trim(),
    dob:modal_dob.value.trim(),
    region:modal_region.value.trim(),
    address:modal_address.value.trim(),
    criminal:modal_criminal.value.trim(),
    driving:modal_driving.value.trim(),
    credit:modal_credit.value.trim(),
    status:modal_status.value
  });

  alert("Saved.");
  modalBackdrop.style.display="none";
  editingId=null;
  loadPage();
};

/* ===========================================================
   ANALYTICS — SEARCH LOGS
   =========================================================== */

async function loadAnalytics(){
  const snaps = await getDocs(query(logsRef, orderBy("timestamp","desc")));

  analyticsBody.innerHTML="";
  let count=0;

  snaps.forEach(log=>{
    const d=log.data();
    count++;

    analyticsBody.innerHTML+=`
      <tr>
        <td>${d.term}</td>
        <td>${d.platform}</td>
        <td>${new Date(d.timestamp.toMillis()).toLocaleString()}</td>
      </tr>
    `;
  });

  totalLogs.textContent=count;
}

/* INITIAL LOAD */
loadPage();
loadAnalytics();

</script>

</body>
</html>

