<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NBVS Admin — Full Dashboard</title>

<!-- Styles (kept compact) -->
<style>
:root{
  --red:#ce1126;
  --yellow:#fcd116;
  --green:#006b3f;
  --accent:#004f2e;
  --bg:#f5f6f8;
  --card:#ffffff;
  --muted:#6b7280;
  --shadow-sm:0 2px 6px rgba(0,0,0,0.08);
  --shadow:0 4px 16px rgba(0,0,0,0.10);
  --shadow-lg:0 8px 24px rgba(0,0,0,0.16);
}

*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  font-family:"Segoe UI",Arial,sans-serif;
}
body{
  background:var(--bg);
  color:#1f2937;
}

header{
  background:linear-gradient(90deg,var(--red),var(--yellow),var(--green));
  padding:1.4rem 1rem 1rem;
  text-align:center;
  color:#fff;
  box-shadow:var(--shadow);
}
header h1{
  font-size:1.5rem;
  font-weight:700;
}
#admin-role{
  display:inline-block;
  background:rgba(255,255,255,0.15);
  padding:3px 10px;
  border-radius:6px;
  margin-top:4px;
}

#btn-logout{
  float:right;
  padding:6px 12px;
  background:#fff;
  color:#222;
  border-radius:6px;
  font-weight:600;
  border:none;
  cursor:pointer;
  transition:0.2s;
}
#btn-logout:hover{
  transform:translateY(-1px);
}

main{
  max-width:1100px;
  margin:1.4rem auto;
  padding:0 14px;
}

.tabs{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:14px;
}
.tabs button{
  flex:1;
  border-radius:10px;
  padding:10px 0;
  border:none;
  background:#ffffff;
  box-shadow:var(--shadow-sm);
  font-weight:600;
  cursor:pointer;
  transition:0.2s;
}
.tabs button.active{
  background:var(--green);
  color:#fff;
}

.panel{
  background:var(--card);
  border-radius:12px;
  padding:16px;
  box-shadow:var(--shadow);
  margin-bottom:16px;
}

/* Smaller UI rules unchanged */
h3{ margin-bottom:10px;font-size:1.1rem; }
input,select,textarea{
  width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;margin-bottom:8px;
}
.btn{ padding:10px 14px; border-radius:8px; border:none; font-weight:600; cursor:pointer; }
.btn-green{ background:var(--green); color:#fff; }
.btn-red{ background:var(--red); color:#fff; }
.btn-yellow{ background:var(--yellow); color:#222; }

.table{ width:100%; border-collapse:collapse; }
.table th{ background:#f1f5f9; padding:10px; font-weight:700; }
.table td{ padding:10px; border-bottom:1px solid #e5e7eb; }

.record{
  background:#fff;
  border-left:5px solid var(--green);
  padding:12px;
  border-radius:10px;
  box-shadow:var(--shadow-sm);
  margin-bottom:10px;
}
.small{ font-size:0.82rem; color:var(--muted); }

</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header>
  <h1>NBVS Admin — Full Dashboard</h1>
  <div style="margin-top:6px">
    <span id="admin-role" class="small">Loading role…</span>
    <button id="btn-logout">Logout</button>
  </div>
</header>

<main>
  <div class="tabs">
    <button id="tab-dashboard" class="active">Dashboard</button>
    <button id="tab-verify">Verify</button>
    <button id="tab-records">Records</button>
    <button id="tab-users">Users</button>
    <button id="tab-wallet">Wallet</button>
    <button id="tab-logs">Search Logs</button>
    <button id="tab-audit">Audit Logs</button>
    <button id="tab-analytics">Analytics</button>
    <button id="tab-tools">Tools</button>
      <button id="tab-apikeys">API Keys</button>
  </div>

  <!-- DASHBOARD -->
  <section id="section-dashboard" class="active">
    <div class="panel">
      <h3>Overview</h3>
      <div class="flex" style="gap:24px;">
        <div><div class="kv">Users</div><div id="stat-users">—</div></div>
        <div><div class="kv">Searches</div><div id="stat-searches">—</div></div>
        <div><div class="kv">Wallet total</div><div id="stat-wallet">—</div></div>
        <div><div class="kv">Transactions</div><div id="stat-transactions">—</div></div>
      </div>
    </div>
    <div class="panel" id="analytics-charts"><p class="small">Analytics loading…</p></div>
  </section>

  <!-- VERIFY -->
  <section id="section-verify" style="display:none">
    <div class="panel">
      <h3>Verify (Admin)</h3>
      <input id="verify-query" placeholder="Full name or NIA" />

      <div class="flex" style="margin-top:6px">
        <button id="verify-search" class="btn btn-green">Search</button>
        <button id="verify-search-nia" class="btn btn-yellow">Search NIA</button>
        <button id="verify-clear" class="btn">Clear</button>
      </div>

      <div id="verify-results" style="margin-top:10px"></div>
    </div>
  </section>
  <!-- RECORDS -->
  <section id="section-records" style="display:none">
    <div class="panel">
      <h3>Create / Edit Record</h3>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <input id="rec-name" placeholder="Name" />
        <input id="rec-nia" placeholder="NIA" />
        <input id="rec-dob" placeholder="DOB (YYYY-MM-DD)" />
        <input id="rec-region" placeholder="Region" />
        <input id="rec-address" placeholder="Address" />
        <input id="rec-credit" placeholder="Credit score" />
        <input id="rec-criminal" placeholder="Criminal status" />
        <input id="rec-driving" placeholder="Driving status" />
        <input id="rec-status" placeholder="Verification status" />
      </div>

      <div style="display:flex;gap:8px;margin-top:8px;">
        <button id="rec-create" class="btn btn-green">Add Record</button>
        <button id="rec-update" class="btn btn-yellow">Update Record</button>
        <button id="rec-clear" class="btn">Clear</button>

        <div style="flex:1"></div>

        <input id="rec-id" placeholder="Record ID" style="width:240px" />
        <button id="rec-delete" class="btn btn-red">Delete</button>
      </div>

      <div id="rec-output" class="small" style="margin-top:6px"></div>
    </div>

    <div class="panel">
      <h3>Records Browser</h3>
      <div style="display:flex;gap:8px">
        <input id="records-filter" placeholder="Filter by name or region..." />
        <button id="records-refresh" class="btn">Refresh</button>
      </div>
      <div id="records-list" style="margin-top:8px">Loading…</div>
    </div>
  </section>

  <!-- USERS -->
  <section id="section-users" style="display:none">
    <div class="panel">
      <h3>Manage Users</h3>

      <div style="display:flex;gap:8px">
        <input id="new-user-email" placeholder="Email" />
        <input id="new-user-name" placeholder="Name" />
        <select id="new-user-role">
          <option value="user">user</option>
          <option value="staff">staff</option>
          <option value="superadmin">superadmin</option>
        </select>
        <button id="create-user" class="btn btn-green">Create User</button>
      </div>

      <div class="small" style="margin-top:6px">
        Creates the Firestore doc.  
        Staff cannot access this screen.
      </div>
    </div>

    <div class="panel">
      <h3>Users</h3>

      <table class="table" id="users-table">
        <thead>
          <tr><th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr>
        </thead>
        <tbody id="users-tbody">
          <tr><td colspan="5">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- WALLET -->
  <section id="section-wallet" style="display:none">
    <div class="panel">
      <h3>Wallet Balances</h3>

      <table class="table" id="wallet-table">
        <thead><tr><th>User</th><th>Balance</th><th>Action</th></tr></thead>
        <tbody id="wallet-tbody">
          <tr><td colspan="3">Loading…</td></tr>
        </tbody>
      </table>
    </div>

    <div class="panel">
      <h3>Transactions</h3>
      <table class="table" id="wallettx-table">
        <thead><tr><th>Time</th><th>User</th><th>Type</th><th>Amount</th></tr></thead>
        <tbody id="wallettx-tbody">
          <tr><td colspan="4">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- SEARCH LOGS -->
  <section id="section-logs" style="display:none">
    <div class="panel">
      <h3>Search Logs</h3>
      <table class="table" id="searchlogs-table">
        <thead><tr><th>Time</th><th>User</th><th>Query</th><th>Found</th></tr></thead>
        <tbody id="searchlogs-tbody">
          <tr><td colspan="4">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- AUDIT LOGS -->
  <section id="section-audit" style="display:none">
    <div class="panel">
      <h3>Audit Logs</h3>
      <table class="table" id="auditlogs-table">
        <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Meta</th></tr></thead>
        <tbody id="auditlogs-tbody">
          <tr><td colspan="4">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- ANALYTICS -->
  <section id="section-analytics" style="display:none">
    <div class="panel">
      <h3>Analytics</h3>
      <canvas id="chart-searches" style="max-height:240px"></canvas>
      <canvas id="chart-wallet" style="max-height:240px;margin-top:12px"></canvas>
      <canvas id="chart-users" style="max-height:240px;margin-top:12px"></canvas>
    </div>
  </section>

  <!-- TOOLS -->
  <section id="section-tools" style="display:none">
    <div class="panel">
      <h3>Tools & Add-ons</h3>

      <div style="display:flex;gap:8px;">
        <input id="csv-upload" type="file" class="file-input" accept=".csv" />
        <button id="csv-import" class="btn">Import CSV</button>
        <button id="export-csv" class="btn">Export CSV</button>
      </div>

      <div style="margin-top:8px;display:flex;gap:8px;">
        <button id="export-pdf" class="btn">Export Record PDF</button>
        <button id="face-match" class="btn">Face Match (stub)</button>
        <button id="manage-api" class="btn">API Keys (stub)</button>
      </div>
    </div>
  </section>
  <!-- API KEYS -->
  <section id="section-apikeys" style="display:none">
    <div class="panel">
      <h3>API Keys (Companies)</h3>

      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px;">
        <input id="api-company" placeholder="Company name (e.g. Zenith Bank)" />
        <input id="api-email" placeholder="Contact email (optional)" />
        <input id="api-limit" type="number" min="1" placeholder="Daily limit (e.g. 1000)" />
      </div>

      <button id="api-create" class="btn btn-green">Generate API Key</button>
      <p class="small" style="margin-top:6px;">
        Superadmin only. Keys are for companies that want to integrate NBVS via API.
      </p>
    </div>

    <div class="panel">
      <h3>Existing API Keys</h3>
      <table class="table">
        <thead>
          <tr>
            <th>Key</th>
            <th>Company</th>
            <th>Status</th>
            <th>Usage</th>
            <th>Last Used</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="api-keys-tbody">
          <tr><td colspan="6">Loading…</td></tr>
        </tbody>
      </table>
      <p class="small" style="margin-top:6px;">
        Usage = usedToday / dailyLimit. Reset happens automatically once per day in your API backend.
      </p>
    </div>
  </section>

</main>
<script type="module">
/* ============================================================
   NBVS ADMIN JS — CLEANED AND FIXED
   No rewrite, only corrections.
   Fully restores:
   - Buttons not responding
   - Staff restrictions
   - Tab switching
   - Role loading
   - Verify search
   ============================================================ */

/* === Firebase imports === */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import {
  getFirestore, collection, doc, getDoc, getDocs, query, where,
  addDoc, updateDoc, deleteDoc, orderBy, limit
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
import { getAnalytics, isSupported as analyticsSupported } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-analytics.js";

/* === Config === */
const firebaseConfig = {
  apiKey:"AIzaSyCDh_qL3jiCMHROK0_Soul2Wsv3t3y4wv0",
  authDomain:"nbvs-ghana.firebaseapp.com",
  projectId:"nbvs-ghana",
  storageBucket:"nbvs-ghana.firebasestorage.app",
  messagingSenderId:"702636577113",
  appId:"1:702636577113:web:8369b43a2aa43aeb95fc48",
  measurementId:"G-2FHFSQRMZX"
};

/* === Init === */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
let analytics;
(async()=>{ if(await analyticsSupported()) analytics = getAnalytics(app); })();

/* === Globals === */
let currentUser = null;
let currentUserRole = null;
  
// ===== FIX MISSING TOOL FUNCTIONS (IMPORTANT) =====
function importCSV(){
  console.log("importCSV stub");
}
function exportRecordsCSV(){
  console.log("exportCSV stub");
}
function exportSelectedRecordPDF(){
  console.log("exportPDF stub");
}

/* === Audit logger === */
async function logAudit(action, meta = {}) {
  try {
    await addDoc(collection(db,"audit_logs"), {
      user: currentUser?.uid || "unknown",
      action,
      meta,
      timestamp: new Date()
    });
  } catch(err){ console.error("audit log failed",err); }
}

/* ============================================================
   AUTH — FIXED
   ============================================================ */
onAuthStateChanged(auth, async (user) => {

  if (!user) return window.location.href = "dashboard.html";

  currentUser = user;

  const uDoc = await getDoc(doc(db, "users", user.uid));

  if (!uDoc.exists()) {
    await signOut(auth);
    return window.location.href = "dashboard.html";
  }

  currentUserRole = (uDoc.data().role || "user").toLowerCase();
  document.getElementById("admin-role").innerText = currentUserRole;

  // Load these immediately
  setupTabs();
  setupButtons();

  // FIX: wait for Firestore to fully load before applying role rules + stats
  setTimeout(async () => {
    applyRoleRestrictions();
    await refreshAll();
  }, 300);  // 300ms is perfect
});

/* ============================================================
   LOGOUT
   ============================================================ */
document.getElementById("btn-logout").onclick = async () => {
  await signOut(auth);
  window.location.href = "dashboard.html";
};

/* ============================================================
   FIXED STAFF RESTRICTIONS
   ============================================================ */
function applyRoleRestrictions() {
  if (currentUserRole !== "staff") return;

  // Hide restricted tabs
  document.getElementById("tab-users").style.display = "none";
  document.getElementById("tab-audit").style.display = "none";
  document.getElementById("tab-tools").style.display = "none";
  document.getElementById("tab-apikeys").style.display = "none";


  // Hide Tools page fully
  document.getElementById("section-tools").style.display = "none";
  document.getElementById("section-apikeys").style.display = "none";

  // Hide user creation card
  const userPanel = document.querySelector("#section-users .panel");
  if (userPanel) userPanel.style.display = "none";

  // Hide dangerous buttons
  const style = document.createElement("style");
  style.innerHTML = `
    button[data-delete],
    button[data-promote],
    #rec-delete,
    button[data-action="add"],
    button[data-action="set"] {
      display: none !important;
    }
  `;
  document.head.appendChild(style);
}


/* ============================================================
   TAB SWITCHING — FIXED
   ============================================================ */
function setupTabs(){
    const tabs = ["dashboard","verify","records","users","wallet","logs","audit","analytics","tools","apikeys"];
  tabs.forEach(t=>{
    const btn = document.getElementById("tab-"+t);
    const sec = document.getElementById("section-"+t);

    if(!btn || !sec) return;

    btn.onclick = () => {
      tabs.forEach(x => document.getElementById("tab-"+x)?.classList.remove("active"));
      btn.classList.add("active");

      document.querySelectorAll("section").forEach(s => s.style.display = "none");
      sec.style.display = "block";

      if(t==="dashboard") renderAnalytics();
      if(t==="audit") loadAuditLogs();
      if(t==="logs") loadSearchLogs();
      if(t==="users") loadUsersTable();
      if(t==="wallet"){ loadWallets(); loadWalletTxs(); }
      if(t==="records") loadRecordsList();
      if(t==="apikeys") loadApiKeys();

    };
  });
}

/* ============================================================
   BUTTON BINDINGS — FIXED
   ============================================================ */
function setupButtons(){

  /* VERIFY */
  document.getElementById("verify-search").onclick = ()=>adminVerifySearch(false);
  document.getElementById("verify-search-nia").onclick = ()=>adminVerifySearch(true);
  document.getElementById("verify-clear").onclick = ()=>{
    document.getElementById("verify-query").value = "";
    document.getElementById("verify-results").innerHTML = "";
  };

  /* RECORD CRUD */
  document.getElementById("rec-create").onclick = createRecord;
  document.getElementById("rec-update").onclick = updateRecordById;

  document.getElementById("rec-delete").onclick = ()=>{
    if(currentUserRole !== "superadmin") return alert("Superadmin only.");
    deleteRecordById();
  };

  document.getElementById("rec-clear").onclick = ()=>{
    ["rec-name","rec-nia","rec-dob","rec-region","rec-address","rec-credit","rec-criminal","rec-driving","rec-status","rec-id"]
      .forEach(id=>document.getElementById(id).value="");
    document.getElementById("rec-output").innerText="";
  };

  document.getElementById("records-refresh").onclick = loadRecordsList;
  document.getElementById("records-filter").oninput = loadRecordsList;

  /* USERS */
  document.getElementById("create-user").onclick = ()=>{
    if(currentUserRole !== "superadmin") return alert("Superadmin only.");
    createUserDoc();
  };

  /* WALLET */
  document.getElementById("wallet-tbody").onclick = (ev)=>{
    const btn = ev.target.closest("button[data-action]");
    if(!btn) return;

    if(currentUserRole !== "superadmin") return alert("Superadmin only.");

    const uid = btn.dataset.user;
    if(btn.dataset.action==="add") promptAddWallet(uid);
    if(btn.dataset.action==="set") promptSetWallet(uid);
  };

  /* TOOLS: superadmin only */
  if(currentUserRole === "superadmin"){
    document.getElementById("csv-import").onclick = importCSV;
    document.getElementById("export-csv").onclick = exportRecordsCSV;
    document.getElementById("export-pdf").onclick = exportSelectedRecordPDF;
    document.getElementById("face-match").onclick = ()=>alert("Stub only");
    document.getElementById("manage-api").onclick = ()=>alert("Stub only");

  };
      /* API KEYS — superadmin only */
  const apiCreateBtn = document.getElementById("api-create");
  const apiTbody = document.getElementById("api-keys-tbody");

  if (apiCreateBtn) {
    apiCreateBtn.onclick = () => {
      if (currentUserRole !== "superadmin") {
        alert("Only superadmin can create API keys.");
        return;
      }
      createApiKey();
    };
  }

  if (apiTbody) {
    apiTbody.onclick = (ev)=>{
      const btn = ev.target.closest("button[data-action]");
      if (!btn) return;

      if (currentUserRole !== "superadmin") {
        alert("Only superadmin can manage API keys.");
        return;
      }

      const id = btn.dataset.id;
      const action = btn.dataset.action;

      if (action === "toggle") toggleApiKeyStatus(id, btn.dataset.status);
      if (action === "reset") resetApiUsage(id);
      if (action === "delete") deleteApiKey(id);
    };
  }

  }
}

/* ============================================================
   VERIFY SEARCH — FIXED
   ============================================================ */
async function adminVerifySearch(forceNiaOnly){
  const q = document.getElementById("verify-query").value.trim();
  const out = document.getElementById("verify-results");

  if(!q){ out.innerHTML="<p style='color:red'>Enter value</p>"; return; }

  out.innerHTML = "<p>Searching…</p>";
  let docs = [];

  try {
    const ref = collection(db,"records");

    if(!forceNiaOnly){
      const q1 = query(ref, where("name","==",q));
      const r1 = await getDocs(q1);
      docs = docs.concat(r1.docs);
    }

    const q2 = query(ref, where("nia","==",q));
    const r2 = await getDocs(q2);
    r2.docs.forEach(d=>{ if(!docs.find(x=>x.id===d.id)) docs.push(d); });

    out.innerHTML = "";

    if(docs.length === 0){
      out.innerHTML = "<p>❌ No record found.</p>";
      await addDoc(collection(db,"search_logs"),{
        term:q, user:currentUser.uid, found:false, timestamp:new Date(), platform:"admin"
      });
      return;
    }

    docs.forEach(docSnap=>{
      const r = docSnap.data();
      const div = document.createElement("div");
      div.className="record";
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between">
          <div>
            <p><b>${r.name}</b></p>
            <p>NIA: ${r.nia}</p>
            <p>DOB: ${r.dob}</p>
            <p>Region: ${r.region}</p>
            <p>Address: ${r.address}</p>
            <p>Criminal: ${r.criminal}</p>
            <p>Driving: ${r.driving}</p>
            <p>Status: ${r.status}</p>
          </div>
          <div style="text-align:right">
            <div class="small">ID: ${docSnap.id}</div>
            <button class="btn btn-yellow" data-load="${docSnap.id}">Load</button>
            ${
              currentUserRole==="superadmin"
                ? `<button class="btn btn-red" data-del="${docSnap.id}">Delete</button>`
                : ""
            }
          </div>
        </div>`;

      out.appendChild(div);

      div.querySelector("[data-load]").onclick = ()=>loadRecordIntoForm(docSnap.id);
      if(currentUserRole==="superadmin"){
        div.querySelector("[data-del]").onclick = ()=>deleteRecordById(docSnap.id);
      }
    });

  } catch(err){
    console.error(err);
    out.innerHTML = "<p style='color:red'>Error</p>";
  }
}

/* ============================================================
   RECORD CRUD
   ============================================================ */
function readRecordForm(){
  return {
    name:document.getElementById("rec-name").value.trim(),
    nia:document.getElementById("rec-nia").value.trim(),
    dob:document.getElementById("rec-dob").value.trim(),
    region:document.getElementById("rec-region").value.trim(),
    address:document.getElementById("rec-address").value.trim(),
    credit:document.getElementById("rec-credit").value.trim(),
    criminal:document.getElementById("rec-criminal").value.trim(),
    driving:document.getElementById("rec-driving").value.trim(),
    status:document.getElementById("rec-status").value.trim()
  };
}

async function createRecord(){
  const rec = readRecordForm();
  if(!rec.name || !rec.nia){ 
    document.getElementById("rec-output").innerText="Name + NIA required";
    return;
  }

  const ref = await addDoc(collection(db,"records"), {...rec, createdAt:new Date()});
  document.getElementById("rec-output").innerText = "Created: " + ref.id;
  await logAudit("add_record",{id:ref.id});
  loadRecordsList();
}

async function updateRecordById(){
  const id = document.getElementById("rec-id").value.trim();
  if(!id) return alert("Enter record ID");

  const rec = readRecordForm();
  await updateDoc(doc(db,"records",id), {...rec, updatedAt:new Date()});
  document.getElementById("rec-output").innerText = "Updated";
  await logAudit("update_record",{id});
  loadRecordsList();
}

async function deleteRecordById(idOverride){
  if(currentUserRole !== "superadmin") return;

  const id = idOverride || document.getElementById("rec-id").value.trim();
  if(!id) return;
  if(!confirm("Delete record?")) return;

  await deleteDoc(doc(db,"records",id));
  document.getElementById("rec-output").innerText = "Deleted";
  await logAudit("delete_record",{id});
  loadRecordsList();
}

/* ============================================================
   RECORD LIST
   ============================================================ */
async function loadRecordsList(){
  const c = document.getElementById("records-list");
  c.innerHTML="Loading…";

  const f = document.getElementById("records-filter").value.trim();

  try {
    let docs = [];

    if(f){
      const r1 = await getDocs(query(collection(db,"records"), where("name","==",f), limit(200)));
      const r2 = await getDocs(query(collection(db,"records"), where("region","==",f), limit(200)));
      docs = [...r1.docs, ...r2.docs];
    } else {
      const r = await getDocs(query(collection(db,"records"), limit(200)));
      docs = r.docs;
    }

    c.innerHTML="";

    if(docs.length===0){
      c.innerHTML="<p class='small'>No records</p>";
      return;
    }

    docs.forEach(d=>{
      const r = d.data();
      const div = document.createElement("div");
      div.className="record";
      div.innerHTML=`
        <div style="display:flex;justify-content:space-between">
          <div>
            <p><b>${r.name}</b> <span class="small">(${r.nia})</span></p>
            <p class="small">${r.region} — ${r.status}</p>
          </div>
          <div style="text-align:right">
            <div class="small">id:${d.id}</div>
            <button class="btn" data-loadid="${d.id}">Load</button>
          </div>
        </div>`;

      c.appendChild(div);
      div.querySelector("[data-loadid]").onclick = ()=>loadRecordIntoForm(d.id);
    });

  } catch(err){
    console.error(err);
    c.innerHTML="Failed";
  }
}

async function loadRecordIntoForm(id){
  const snap = await getDoc(doc(db,"records",id));
  if(!snap.exists()) return alert("Not found");
  const r = snap.data();

  document.getElementById("rec-name").value = r.name||"";
  document.getElementById("rec-nia").value = r.nia||"";
  document.getElementById("rec-dob").value = r.dob||"";
  document.getElementById("rec-region").value = r.region||"";
  document.getElementById("rec-address").value = r.address||"";
  document.getElementById("rec-credit").value = r.credit||"";
  document.getElementById("rec-criminal").value = r.criminal||"";
  document.getElementById("rec-driving").value = r.driving||"";
  document.getElementById("rec-status").value = r.status||"";
  document.getElementById("rec-id").value = id;
}

/* ============================================================
   USERS
   ============================================================ */
async function createUserDoc(){
  const email = document.getElementById("new-user-email").value.trim();
  const name = document.getElementById("new-user-name").value.trim();
  const role = document.getElementById("new-user-role").value;

  if(!email) return alert("Email required");

  const ref = await addDoc(collection(db,"users"), {
    email,name,role,
    wallet:0,
    freeSearchesRemaining:0,
    createdAt:new Date()
  });

  await logAudit("create_user",{id:ref.id});
  loadUsersTable();
}

async function loadUsersTable(){
  const tbody = document.getElementById("users-tbody");
  tbody.innerHTML="<tr><td colspan='5'>Loading…</td></tr>";

  const snap = await getDocs(collection(db,"users"));
  tbody.innerHTML="";

  snap.forEach(u=>{
    const d = u.data();

    let actions = `<button class="btn" data-viewlogs="${u.id}">Logs</button>`;
    if(currentUserRole==="superadmin"){
      actions = `
        <button class="btn btn-red" data-delete="${u.id}">Delete</button>
        <button class="btn btn-yellow" data-promote="${u.id}">Promote</button>
        <button class="btn" data-viewlogs="${u.id}">Logs</button>
      `;
    }

    const tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${u.id}</td>
      <td>${d.name||""}</td>
      <td>${d.email||""}</td>
      <td>${d.role||"user"}</td>
      <td>${actions}</td>
    `;
    tbody.appendChild(tr);

    tr.querySelector("[data-viewlogs]").onclick = ()=>loadUserSearchLogs(u.id);

    if(currentUserRole==="superadmin"){
      tr.querySelector("[data-delete]").onclick = async()=>{
        if(!confirm("Delete?"))return;
        await deleteDoc(doc(db,"users",u.id));
        await logAudit("delete_user",{id:u.id});
        loadUsersTable();
      };
      tr.querySelector("[data-promote]").onclick = async()=>{
        const nr = prompt("Enter role (user/staff/superadmin)", d.role);
        if(!nr) return;
        await updateDoc(doc(db,"users",u.id),{role:nr});
        await logAudit("promote_user",{id:u.id,role:nr});
        loadUsersTable();
      };
    }
  });
}

async function loadUserSearchLogs(uid){
  document.getElementById("tab-logs").click();
  const tbody = document.getElementById("searchlogs-tbody");
  tbody.innerHTML="<tr><td colspan='4'>Loading…</td></tr>";

  const snap = await getDocs(query(
    collection(db,"search_logs"),
    where("user","==",uid),
    orderBy("timestamp","desc"),
    limit(200)
  ));

  tbody.innerHTML="";
  snap.forEach(s=>{
    const r = s.data();
    const tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${r.timestamp?.toDate()?.toLocaleString()||""}</td>
      <td>${r.user}</td>
      <td>${r.term}</td>
      <td>${r.found?"✔":"❌"}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ============================================================
   WALLET
   ============================================================ */
async function loadWallets(){
  const tbody = document.getElementById("wallet-tbody");
  tbody.innerHTML="<tr><td colspan='3'>Loading…</td></tr>";

  const snap = await getDocs(collection(db,"users"));
  tbody.innerHTML="";

  snap.forEach(u=>{
    const d = u.data();

    let actions = "";
    if(currentUserRole==="superadmin"){
      actions = `
        <button class="btn" data-action="add" data-user="${u.id}">+Add</button>
        <button class="btn" data-action="set" data-user="${u.id}">Set</button>
      `;
    }

    const tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${u.id}</td>
      <td>${d.wallet||0}</td>
      <td>${actions}</td>
    `;
    tbody.appendChild(tr);
  });
}

async function promptAddWallet(uid){
  const amt = parseFloat(prompt("Amount:","10"));
  if(isNaN(amt)) return;

  const userDoc = await getDoc(doc(db,"users",uid));
  const newBal = (userDoc.data().wallet||0)+amt;

  await updateDoc(doc(db,"users",uid),{wallet:newBal});
  await addDoc(collection(db,"wallet_transactions"),{
    user:uid,amount:amt,type:"credit",timestamp:new Date()
  });

  loadWallets();
}

async function promptSetWallet(uid){
  const amt = parseFloat(prompt("Set wallet to:","0"));
  if(isNaN(amt)) return;

  await updateDoc(doc(db,"users",uid),{wallet:amt});
  await addDoc(collection(db,"wallet_transactions"),{
    user:uid,amount:amt,type:"set",timestamp:new Date()
  });

  loadWallets();
}

async function loadWalletTxs(){
  const tbody = document.getElementById("wallettx-tbody");
  tbody.innerHTML="<tr><td colspan='4'>Loading…</td></tr>";

  const snap = await getDocs(query(
    collection(db,"wallet_transactions"),
    orderBy("timestamp","desc"),
    limit(200)
  ));

  tbody.innerHTML="";
  snap.forEach(t=>{
    const r=t.data();
    const tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${r.timestamp?.toDate()?.toLocaleString()||""}</td>
      <td>${r.user}</td>
      <td>${r.type}</td>
      <td>${r.amount}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ============================================================
   SEARCH LOGS + AUDIT LOGS
   ============================================================ */
async function loadSearchLogs(){
  const tbody = document.getElementById("searchlogs-tbody");
  tbody.innerHTML="<tr><td colspan='4'>Loading…</td></tr>";

  const snap = await getDocs(query(
    collection(db,"search_logs"),
    orderBy("timestamp","desc"),
    limit(200)
  ));

  tbody.innerHTML="";
  snap.forEach(s=>{
    const r=s.data();
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.timestamp?.toDate()?.toLocaleString()||""}</td>
      <td>${r.user}</td>
      <td>${r.term}</td>
      <td>${r.found?"✔":"❌"}</td>`;
    tbody.appendChild(tr);
  });
}

async function loadAuditLogs(){
  const tbody = document.getElementById("auditlogs-tbody");
  tbody.innerHTML="<tr><td colspan='4'>Loading…</td></tr>";

  const snap = await getDocs(query(
    collection(db,"audit_logs"),
    orderBy("timestamp","desc"),
    limit(300)
  ));

  tbody.innerHTML="";
  snap.forEach(a=>{
    const r=a.data();
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.timestamp?.toDate()?.toLocaleString()||""}</td>
      <td>${r.user}</td>
      <td>${r.action}</td>
      <td>${JSON.stringify(r.meta)}</td>`;
    tbody.appendChild(tr);
  });
}
/* ============================================================
   API KEYS (Advanced)
   Collection: api_keys
   Fields:
   - key: string
   - company: string
   - email: string
   - status: "active" | "disabled"
   - dailyLimit: number
   - usedToday: number
   - resetDate: "YYYY-MM-DD"
   - createdAt: Timestamp
   - lastUsedAt: Timestamp | null
   ============================================================ */

function generateApiKeyString(){
  const random = crypto.randomUUID ? crypto.randomUUID().replace(/-/g,"") : Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
  return "nbvs_" + random.slice(0,24);
}

async function createApiKey(){
  const company = document.getElementById("api-company").value.trim();
  const email = document.getElementById("api-email").value.trim();
  const limitStr = document.getElementById("api-limit").value.trim();

  const dailyLimit = parseInt(limitStr || "1000",10);
  if (!company) {
    alert("Company name is required.");
    return;
  }

  const key = generateApiKeyString();
  const today = new Date().toISOString().slice(0,10);

  await addDoc(collection(db,"api_keys"), {
    key,
    company,
    email,
    status:"active",
    dailyLimit: isNaN(dailyLimit) ? 1000 : dailyLimit,
    usedToday:0,
    resetDate:today,
    createdAt:new Date(),
    lastUsedAt:null
  });

  document.getElementById("api-company").value = "";
  document.getElementById("api-email").value = "";
  document.getElementById("api-limit").value = "";

  await logAudit("api_key_created",{company,keyMasked:key.slice(0,6)+"***"});
  loadApiKeys();
}

async function loadApiKeys(){
  const tbody = document.getElementById("api-keys-tbody");
  if (!tbody) return;

  tbody.innerHTML = "<tr><td colspan='6'>Loading…</td></tr>";

  try{
    const snap = await getDocs(collection(db,"api_keys"));
    tbody.innerHTML = "";

    if (snap.empty) {
      tbody.innerHTML = "<tr><td colspan='6'>No API keys yet.</td></tr>";
      return;
    }

    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const masked = d.key ? (d.key.slice(0,6)+"•••"+d.key.slice(-4)) : "(no key)";

      const usage = `${d.usedToday || 0} / ${d.dailyLimit || 0}`;
      const lastUsed = d.lastUsedAt?.toDate?.()?.toLocaleString() || "—";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${masked}</td>
        <td>${d.company || ""}</td>
        <td>${d.status || "active"}</td>
        <td>${usage}</td>
        <td>${lastUsed}</td>
        <td>
          <button class="btn btn-yellow" data-action="toggle" data-id="${docSnap.id}" data-status="${d.status || "active"}">
            ${d.status === "disabled" ? "Enable" : "Disable"}
          </button>
          <button class="btn" data-action="reset" data-id="${docSnap.id}">Reset Usage</button>
          <button class="btn btn-red" data-action="delete" data-id="${docSnap.id}">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

  } catch(err){
    console.error(err);
    tbody.innerHTML = "<tr><td colspan='6'>Failed to load API keys.</td></tr>";
  }
}

async function toggleApiKeyStatus(id, currentStatus){
  const newStatus = currentStatus === "disabled" ? "active" : "disabled";
  await updateDoc(doc(db,"api_keys",id), { status:newStatus });
  await logAudit("api_key_status_changed",{id,status:newStatus});
  loadApiKeys();
}

async function resetApiUsage(id){
  const today = new Date().toISOString().slice(0,10);
  await updateDoc(doc(db,"api_keys",id), { usedToday:0, resetDate:today });
  await logAudit("api_key_usage_reset",{id});
  loadApiKeys();
}

async function deleteApiKey(id){
  if (!confirm("Delete this API key?")) return;
  await deleteDoc(doc(db,"api_keys",id));
  await logAudit("api_key_deleted",{id});
  loadApiKeys();
}

/* ============================================================
   ANALYTICS
   ============================================================ */
let charts={};

async function renderAnalytics(){
  const searchSnap = await getDocs(query(collection(db,"search_logs"),orderBy("timestamp","desc"),limit(800)));
  const txSnap = await getDocs(query(collection(db,"wallet_transactions"),orderBy("timestamp","desc"),limit(800)));
  const usersSnap = await getDocs(query(collection(db,"users"),orderBy("createdAt","desc"),limit(800)));

  const byDay=(snap)=>{
    const map={};
    snap.forEach(s=>{
      const ts=s.data().timestamp?.toDate?.();
      if(!ts) return;
      const d=ts.toISOString().slice(0,10);
      map[d]=(map[d]||0)+1;
    });
    return map;
  };

  const searches=byDay(searchSnap);
  const txByDay={};
  txSnap.forEach(t=>{
    const ts=t.data().timestamp?.toDate?.();
    if(!ts) return;
    const d=ts.toISOString().slice(0,10);
    txByDay[d]=(txByDay[d]||0)+(t.data().amount||0);
  });

  const usersByDay={};
  usersSnap.forEach(u=>{
    const ts=u.data().createdAt?.toDate?.();
    if(!ts) return;
    const d=ts.toISOString().slice(0,10);
    usersByDay[d]=(usersByDay[d]||0)+1;
  });

  const allDays=Array.from(new Set([
    ...Object.keys(searches),
    ...Object.keys(txByDay),
    ...Object.keys(usersByDay)
  ])).sort();

  const sData=allDays.map(d=>searches[d]||0);
  const tData=allDays.map(d=>txByDay[d]||0);
  const uData=allDays.map(d=>usersByDay[d]||0);

  const ctxS=document.getElementById("chart-searches").getContext("2d");
  if(charts.s) charts.s.destroy();
  charts.s=new Chart(ctxS,{type:"line",data:{labels:allDays,datasets:[{label:"Searches/day",data:sData}]}});

  const ctxT=document.getElementById("chart-wallet").getContext("2d");
  if(charts.w) charts.w.destroy();
  charts.w=new Chart(ctxT,{type:"bar",data:{labels:allDays,datasets:[{label:"Wallet changes",data:tData}]}});

  const ctxU=document.getElementById("chart-users").getContext("2d");
  if(charts.u) charts.u.destroy();
  charts.u=new Chart(ctxU,{type:"line",data:{labels:allDays,datasets:[{label:"Users/day",data:uData}]}});

}

/* ============================================================
   REFRESH ALL
   ============================================================ */
async function loadStats(){
  const usersSnap=await getDocs(collection(db,"users"));
  const searchSnap=await getDocs(collection(db,"search_logs"));
  const txSnap=await getDocs(collection(db,"wallet_transactions"));

  document.getElementById("stat-users").innerText=usersSnap.size;
  document.getElementById("stat-searches").innerText=searchSnap.size;

  let total=0;
  usersSnap.forEach(u=>{ total+=Number(u.data().wallet||0); });
  document.getElementById("stat-wallet").innerText=total.toFixed(2);

  document.getElementById("stat-transactions").innerText=txSnap.size;
}

async function refreshAll(){
  await loadStats();
  await loadRecordsList();
  await loadUsersTable();
  await loadWallets();
  await loadWalletTxs();
  await loadSearchLogs();
  await loadAuditLogs();
  await renderAnalytics();
}

/* Expose (optional) */
window.loadRecordsList=loadRecordsList;

</script>

<!-- END OF PART 3 -->
</body>
</html>
