<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NBVS Admin Dashboard</title>

<style>
:root{
  --red:#ce1126;
  --yellow:#fcd116;
  --green:#006b3f;
  --accent:#004f2e;
  --card:#fff;
  --bg:#f6f7f9;
  --muted:#555;
  --shadow: rgba(0,0,0,0.08);
}

*{box-sizing:border-box;margin:0;padding:0;font-family:"Segoe UI",Arial,sans-serif;}

body{background:var(--bg);color:#222;}
header{
  background:linear-gradient(90deg,var(--red),var(--yellow),var(--green));
  padding:1.5rem 1rem;
  text-align:center;
  color:white;
  font-weight:700;
  box-shadow:0 3px 12px rgba(0,0,0,0.15);
}
header h1{font-size:1.6rem;margin-bottom:4px;}
header span{font-weight:400;font-size:0.9rem;}

main{max-width:1000px;margin:1.5rem auto;padding:0 1rem;}

.tabs{
  display:flex;
  gap:10px;
  margin-bottom:1rem;
}
.tabs button{
  flex:1;
  padding:10px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
  background:white;
  transition:.2s;
}
.tabs button.active{background:var(--green);color:white;}
.tabs button:hover:not(.active){background:#ddd;}

section{display:none;}
section.active{display:block;}

.panel{
  background:var(--card);
  padding:1.2rem;
  border-radius:12px;
  box-shadow:0 6px 20px var(--shadow);
  margin-bottom:1.4rem;
}

input, select{padding:10px;border-radius:8px;border:1px solid #ccc;margin-bottom:10px;width:100%;}

button.btn-green{background:var(--green);color:white;}
button.btn-red{background:var(--red);color:white;}
button.btn-yellow{background:var(--yellow);color:#111;}
button{border:none;padding:10px;border-radius:8px;cursor:pointer;font-weight:600;transition:.2s;}
button:hover{transform:translateY(-2px);}

table{width:100%;border-collapse:collapse;margin-top:10px;}
th, td{padding:8px;text-align:left;border-bottom:1px solid #ddd;}
th{background:#f0f0f0;}

.record{
  background:white;
  border-left:5px solid var(--green);
  padding:1rem;
  border-radius:10px;
  margin-top:1rem;
  box-shadow:0 6px 20px rgba(0,0,0,0.06);
}

.muted{color:var(--muted);}
</style>
</head>
<body>

<header>
  <h1>NBVS Admin Dashboard</h1>
  <span id="admin-role">Loading role…</span>
  <button id="btn-logout" style="float:right;margin-top:-24px;padding:6px 12px;">Logout</button>
</header>

<main>
  <div class="tabs">
    <button id="tab-dashboard" class="active">Dashboard</button>
    <button id="tab-verify">Verify</button>
    <button id="tab-users">Users</button>
    <button id="tab-logs">Search Logs</button>
    <button id="tab-wallet">Wallet</button>
    <button id="tab-audit">Audit Logs</button>
  </div>

  <!-- Dashboard -->
  <section id="section-dashboard" class="active">
    <div class="panel">
      <h3>Stats</h3>
      <p>Users: <span id="stat-users">—</span></p>
      <p>Searches: <span id="stat-searches">—</span></p>
      <p>Wallet Total: $<span id="stat-wallet">—</span></p>
      <p>Transactions: <span id="stat-transactions">—</span></p>
    </div>
    <div class="panel" id="analytics-status">Loading Analytics…</div>
  </section>

  <!-- Verify -->
  <section id="section-verify">
    <div class="panel">
      <label>Search by name or NIA</label>
      <input id="verify-input" placeholder="Enter name or NIA" />
      <div style="display:flex;gap:10px;margin-top:8px;">
        <button id="btn-verify-name" class="btn-green">Search</button>
      </div>
      <div id="verify-output" style="margin-top:12px;"></div>
    </div>
  </section>

  <!-- Users -->
  <section id="section-users">
    <div class="panel">
      <h3>Users</h3>
      <table>
        <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead>
        <tbody id="users-body"><tr><td colspan="5">Loading…</td></tr></tbody>
      </table>
    </div>
  </section>

  <!-- Search Logs -->
  <section id="section-searchlogs">
    <div class="panel">
      <h3>Search Logs</h3>
      <table>
        <thead><tr><th>Time</th><th>User</th><th>Query</th><th>Result</th></tr></thead>
        <tbody id="searchlogs-body"><tr><td colspan="4">Loading…</td></tr></tbody>
      </table>
    </div>
  </section>

  <!-- Wallet -->
  <section id="section-wallet">
    <div class="panel">
      <h3>Wallet</h3>
      <table>
        <thead><tr><th>User</th><th>Balance</th></tr></thead>
        <tbody id="wallet-body"><tr><td colspan="2">Loading…</td></tr></tbody>
      </table>
      <h3>Transactions</h3>
      <table>
        <thead><tr><th>Time</th><th>User</th><th>Type</th><th>Amount</th></tr></thead>
        <tbody id="wallettx-body"><tr><td colspan="4">Loading…</td></tr></tbody>
      </table>
    </div>
  </section>

  <!-- Audit Logs -->
  <section id="section-audit">
    <div class="panel">
      <h3>Audit Logs</h3>
      <table>
        <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Meta</th></tr></thead>
        <tbody id="audit-logs-body"><tr><td colspan="4">Loading…</td></tr></tbody>
      </table>
    </div>
  </section>

</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, getDocs, query, where, updateDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
import { getAnalytics, isSupported as analyticsSupported } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-analytics.js";

// ------------------ Firebase Config ------------------
const firebaseConfig = {
  apiKey:"AIzaSyCDh_qL3jiCMHROK0_Soul2Wsv3t3y4wv0",
  authDomain:"nbvs-ghana.firebaseapp.com",
  projectId:"nbvs-ghana",
  storageBucket:"nbvs-ghana.firebasestorage.app",
  messagingSenderId:"702636577113",
  appId:"1:702636577113:web:8369b43a2aa43aeb95fc48",
  measurementId:"G-2FHFSQRMZX"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
let analytics;
(async()=>{ if(await analyticsSupported()) analytics=getAnalytics(app); })();

let currentUser, currentUserRole;

// ------------------ Auth & Role ------------------
onAuthStateChanged(auth, async(user)=>{
  currentUser = user;
  if(!user) return window.location.href="/dashboard.html";
  const uDoc = await getDoc(doc(db,"users",user.uid));
  if(!uDoc.exists()){ await signOut(auth); return window.location.href="/dashboard.html"; }
  currentUserRole = uDoc.data().role || "user";
  if(!["superadmin","staff"].includes(currentUserRole)){ await signOut(auth); return window.location.href="/dashboard.html"; }
  document.getElementById("admin-role").textContent = currentUserRole;
  setupBindings(); 
  await loadInitialData();
});

// ------------------ Logout ------------------
document.getElementById("btn-logout").onclick = async()=>{ await signOut(auth); window.location.href="/dashboard.html"; };

// ------------------ Tabs ------------------
function setupBindings(){
  const tabs=["dashboard","verify","users","logs","wallet","audit"];
  tabs.forEach(t=>{
    const btn = document.getElementById("tab-"+t);
    const sec = document.getElementById("section-"+(t==="logs"?"searchlogs":t));
    if(btn && sec){
      btn.onclick = ()=>{
        tabs.forEach(x=>document.getElementById("tab-"+x).classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
        sec.classList.add("active");
        if(t==="dashboard"){ loadStats(); loadAnalyticsUI(); }
      }
    }
  });

  // ------------------ VERIFY FOR ADMINS ------------------
  const verifyInput = document.getElementById("verify-input");
  const verifyBtn = document.getElementById("btn-verify-name");
  const verifyOutput = document.getElementById("verify-output");

  verifyBtn.onclick = async () => {
    const text = verifyInput.value.trim();
    verifyOutput.innerHTML = "";

    if(!text){
      verifyOutput.innerHTML = "<p style='color:red'>Enter name or NIA</p>";
      return;
    }

    verifyOutput.innerHTML = "<p>Loading…</p>";

    try{
      const q = query(collection(db,"records"), where("name","==",text));
      const snap = await getDocs(q);

      if(snap.empty){
        verifyOutput.innerHTML = "<p>❌ No record found.</p>";
        await addDoc(collection(db,"search_logs"),{
          term: text,
          user: currentUser.uid,
          timestamp: new Date(),
          found: false
        });
        return;
      }

      verifyOutput.innerHTML = "";
      snap.forEach(docSnap => {
        const r = docSnap.data();
        verifyOutput.innerHTML += `
          <div class="record">
            <h3>${r.name}</h3>
            <p><b>NIA:</b> ${r.nia}</p>
            <p><b>DOB:</b> ${r.dob}</p>
            <p><b>Region:</b> ${r.region}</p>
            <p><b>Address:</b> ${r.address}</p>
            <p><b>Criminal:</b> ${r.criminal}</p>
            <p><b>Driving:</b> ${r.driving}</p>
            <p><b>Credit:</b> ${r.credit}</p>
            <p><b>Status:</b> ${r.status}</p>
          </div>
        `;
      });

      // Log search
      await addDoc(collection(db,"search_logs"),{
        term: text,
        user: currentUser.uid,
        timestamp: new Date(),
        found: true
      });

    } catch(e){
      console.error(e);
      verifyOutput.innerHTML = "<p style='color:red'>Error loading record</p>";
    }
  };
}

// ------------------ Load Initial Data ------------------
async function loadInitialData(){
  await loadStats(); 
  await loadUsers(); 
  await loadSearchLogs(); 
  await loadWallet(); 
  await loadAuditLogs();
}

// ------------------ Stats ------------------
async function loadStats(){
  const usersSnap = await getDocs(collection(db,"users"));
  const searchSnap = await getDocs(collection(db,"search_logs"));
  const walletSnap = await getDocs(collection(db,"wallet_transactions"));

  document.getElementById("stat-users").textContent = usersSnap.size;
  document.getElementById("stat-searches").textContent = searchSnap.size;

  let totalWallet = 0;
  walletSnap.forEach(s => totalWallet += s.data().amount || 0);
  document.getElementById("stat-wallet").textContent = totalWallet;
  document.getElementById("stat-transactions").textContent = walletSnap.size;
}

// ------------------ Users ------------------
async function loadUsers(){
  const tbody = document.getElementById("users-body");
  const snap = await getDocs(collection(db,"users"));
  tbody.innerHTML="";
  snap.forEach(u=>{
    const d = u.data();
    tbody.innerHTML+=`
      <tr>
        <td>${u.id}</td>
        <td>${d.name||""}</td>
        <td>${d.email||""}</td>
        <td>${d.role||"user"}</td>
        <td>
          <button onclick="deleteUser('${u.id}')" class="btn-red">Delete</button>
        </td>
      </tr>`;
  });
}

// ------------------ Admin Actions ------------------
window.deleteUser = async(id)=>{
  if(!confirm("Delete user?")) return;
  await deleteDoc(doc(db,"users",id));
  loadUsers();
};

// ------------------ Search Logs ------------------
async function loadSearchLogs(){
  const tbody = document.getElementById("searchlogs-body");
  const snap = await getDocs(collection(db,"search_logs"));
  tbody.innerHTML="";
  snap.forEach(d=>{
    const s=d.data();
    tbody.innerHTML+=`<tr>
      <td>${s.timestamp?.toDate?.()?.toLocaleString()||""}</td>
      <td>${s.user||""}</td>
      <td>${s.term||""}</td>
      <td>${s.found?"✔":"❌"}</td>
    </tr>`;
  });
}

// ------------------ Wallet ------------------
async function loadWallet(){
  const tbody = document.getElementById("wallet-body");
  const snap = await getDocs(collection(db,"users"));
  tbody.innerHTML="";
  snap.forEach(u=>{
    const d=u.data();
    tbody.innerHTML+=`<tr><td>${u.id}</td><td>${d.wallet||0}</td></tr>`;
  });

  const txBody = document.getElementById("wallettx-body");
  const txSnap = await getDocs(collection(db,"wallet_transactions"));
  txBody.innerHTML="";
  txSnap.forEach(t=>{
    const tx=t.data();
    txBody.innerHTML+=`<tr><td>${tx.timestamp?.toDate?.()?.toLocaleString()||""}</td><td>${tx.user||""}</td><td>${tx.type||""}</td><td>${tx.amount||0}</td></tr>`;
  });
}

// ------------------ Audit Logs ------------------
async function loadAuditLogs(){
  const tbody = document.getElementById("audit-logs-body");
  const snap = await getDocs(collection(db,"audit_logs"));
  tbody.innerHTML="";
  snap.forEach(d=>{
    const a=d.data();
    tbody.innerHTML+=`<tr><td>${a.timestamp?.toDate?.()?.toLocaleString()||""}</td><td>${a.user||""}</td><td>${a.action||""}</td><td>${JSON.stringify(a.meta)||""}</td></tr>`;
  });
}

// ------------------ Analytics Placeholder ------------------
function loadAnalyticsUI(){
  document.getElementById("analytics-status").innerHTML="<p>Analytics coming soon…</p>";
}
</script>
</body>
</html>
