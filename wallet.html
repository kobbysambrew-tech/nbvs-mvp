<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NBVS Wallet — Top Up</title>
<style>
  body{font-family:"Segoe UI",Arial,sans-serif;background:#f8f9fa;margin:0}
  header{background:linear-gradient(to right,#ce1126,#fcd116,#006b3f);color:#fff;padding:1.2rem;text-align:center}
  main{max-width:700px;margin:2rem auto;background:#fff;padding:1.6rem;border-radius:10px;box-shadow:0 3px 12px rgba(0,0,0,0.08)}
  .balance{font-size:2rem;color:#006b3f;font-weight:700;margin:0.5rem 0}
  button{padding:10px 14px;border:none;border-radius:8px;cursor:pointer;margin:6px 0;width:100%}
  .topup{background:#ffd54f;color:#000}
  .tx{background:#f5f5f5;padding:10px;border-radius:8px;margin-top:10px}
  .row{display:flex;gap:10px}
  .col{flex:1}
  .small{font-size:0.95rem;color:#555}
  a{color:#006b3f;text-decoration:none}
</style>
</head>
<body>
<header><h1>NBVS Wallet — Top Up (Global)</h1></header>
<main>
  <p class="small">This is the global NBVS Wallet used for beta testing. Each verify contributes to the system balance.</p>

  <div>
    <div>Global Balance</div>
    <div id="balance" class="balance">Loading…</div>
  </div>

  <h3>Quick Top-Up (Simulated Payment)</h3>

  <div class="row">
    <div class="col"><button class="topup" data-amount="5">Top up $5</button></div>
    <div class="col"><button class="topup" data-amount="10">Top up $10</button></div>
  </div>

  <div class="row">
    <div class="col"><button class="topup" data-amount="25">Top up $25</button></div>
    <div class="col"><button class="topup" data-amount="50">Top up $50</button></div>
  </div>

  <p class="small">These simulate Stripe payments and update the global NBVS Wallet balance.</p>

  <h3>Recent Transactions (last 10)</h3>
  <div id="txList">Loading…</div>

  <p style="margin-top:1rem"><a href="verify.html">← Back to Verify</a></p>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc,
    collection, addDoc, getDocs, query, orderBy, limit
  } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

  // ✅ Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyCDh_qL3jiCMHROK0_Soul2Wsv3t3y4wv0",
    authDomain: "nbvs-ghana.firebaseapp.com",
    projectId: "nbvs-ghana",
    storageBucket: "nbvs-ghana.firebasestorage.app",
    messagingSenderId: "702636577113",
    appId: "1:702636577113:web:8369b43a2aa43aeb95fc48",
    measurementId: "G-2FHFSQRMZX"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ✅ FIXED — USE stats/global instead of wallet/global
  const BALANCE_DOC = doc(db, "stats", "global");

  // ✅ Transactions go into walletTransactions
  const TX_COLL = collection(db, "walletTransactions");

  const balanceEl = document.getElementById("balance");
  const txListEl = document.getElementById("txList");

  // ✅ Ensure stats/global exists
  async function ensureWallet() {
    const snap = await getDoc(BALANCE_DOC);
    if (!snap.exists()) {
      await setDoc(BALANCE_DOC, {
        walletBalance: 0,
        totalSearches: 0,
        totalLogins: 0
      });
      return 0;
    }
    return snap.data().walletBalance || 0;
  }

  async function refreshBalance() {
    const snap = await getDoc(BALANCE_DOC);
    if (!snap.exists()) {
      balanceEl.textContent = "Error";
      return;
    }
    const bal = snap.data().walletBalance || 0;
    balanceEl.textContent = `$ ${bal.toFixed(2)}`;
    return bal;
  }

  async function loadTx() {
    txListEl.innerHTML = "Loading...";
    const q = query(TX_COLL, orderBy("timestamp", "desc"), limit(10));
    const snaps = await getDocs(q);
    txListEl.innerHTML = "";

    if (snaps.empty) {
      txListEl.innerHTML = "<div class='small'>No transactions yet.</div>";
      return;
    }

    snaps.forEach(d => {
      const t = d.data();
      const el = document.createElement("div");
      el.className = "tx";

      el.innerHTML = `
        <strong>${t.type.toUpperCase()}</strong> — $${t.amount}<br>
        <span class="small">${new Date(t.timestamp).toLocaleString()}</span><br>
        <span class="small">${t.note || ""}</span>
      `;

      txListEl.appendChild(el);
    });
  }

  async function fakeTopUp(amount) {
    const snap = await getDoc(BALANCE_DOC);
    let current = snap.exists() ? (snap.data().walletBalance || 0) : 0;

    const newBal = current + Number(amount);

    await updateDoc(BALANCE_DOC, { walletBalance: newBal });

    await addDoc(TX_COLL, {
      type: "topup",
      amount: Number(amount),
      timestamp: Date.now(),
      note: "Simulated beta top-up"
    });

    await refreshBalance();
    await loadTx();
    alert(`✅ Top-up successful — new balance: $${newBal}`);
  }

  document.querySelectorAll(".topup").forEach(btn => {
    btn.addEventListener("click", async () => {
      const amt = Number(btn.dataset.amount);
      if (!confirm(`Simulate top-up of $${amt}?`)) return;
      await ensureWallet();
      await fakeTopUp(amt);
    });
  });

  // ✅ Initialize page
  (async () => {
    try {
      await ensureWallet();
      await refreshBalance();
      await loadTx();
    } catch (err) {
      console.error(err);
      balanceEl.textContent = "Error";
      txListEl.textContent = "Error loading transactions.";
    }
  })();
</script>
</body>
</html>

