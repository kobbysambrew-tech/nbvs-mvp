<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NBVS Wallet — Top Up (Ghana)</title>

<style>
  body {
    font-family:"Segoe UI",Arial,sans-serif;
    background:#f8f9fa;
    margin:0;
  }
  header {
    background:linear-gradient(to right,#ce1126,#fcd116,#006b3f);
    color:#fff;
    padding:1.2rem;
    text-align:center;
  }
  main {
    max-width:700px;
    margin:2rem auto;
    background:#fff;
    padding:1.6rem;
    border-radius:10px;
    box-shadow:0 3px 12px rgba(0,0,0,0.08);
  }
  .balance {
    font-size:2rem;
    color:#006b3f;
    font-weight:700;
    margin:0.5rem 0;
  }
  .topup {
    background:#fcd116;
    color:#000;
    padding:12px 18px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    width:100%;
    margin:6px 0;
    font-size:1rem;
    font-weight:bold;
  }
  .tx {
    background:#f1f1f1;
    padding:10px;
    border-radius:8px;
    margin-top:10px;
  }
  .small { color:#555; }
  a { color:#006b3f; text-decoration:none; }
</style>
</head>

<body>
<header>
  <h1>NBVS Wallet — Global Balance</h1>
</header>

<main>
  <p class="small">
    This is the NBVS Beta Wallet.  
    Each background lookup costs <b>GHC 30</b>.
  </p>

  <div>
    <h3>Wallet Balance</h3>
    <div id="balance" class="balance">Loading…</div>
  </div>

  <h3>Quick Top-Up</h3>
  
  <button class="topup" data-amount="30">Add GHC 30</button>
  <button class="topup" data-amount="50">Add GHC 50</button>
  <button class="topup" data-amount="100">Add GHC 100</button>
  <button class="topup" data-amount="200">Add GHC 200</button>

  <h3>Recent Transactions</h3>
  <div id="txList">Loading…</div>

  <p><a href="verify.html">← Back to Verify</a></p>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc,
    collection, addDoc, getDocs, query, orderBy, limit
  } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

  // ✅ Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCDh_qL3jiCMHROK0_Soul2Wsv3t3y4wv0",
    authDomain: "nbvs-ghana.firebaseapp.com",
    projectId: "nbvs-ghana",
    storageBucket: "nbvs-ghana.firebasestorage.app",
    messagingSenderId: "702636577113",
    appId: "1:702636577113:web:8369b43a2aa43aeb95fc48",
    measurementId: "G-2FHFSQRMZX"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ✅ Wallet references
  const WALLET_DOC = doc(db, "wallet", "global");
  const TX_COLL = collection(db, "walletTransactions");

  const balanceEl = document.getElementById("balance");
  const txListEl = document.getElementById("txList");

  // ✅ Make sure wallet exists
  async function ensureWalletExists() {
    const snap = await getDoc(WALLET_DOC);
    if (!snap.exists()) {
      await setDoc(WALLET_DOC, { balance: 0 });
      return 0;
    }
    return snap.data().balance || 0;
  }

  // ✅ Load wallet balance
  async function refreshBalance() {
    const snap = await getDoc(WALLET_DOC);
    const bal = snap.exists() ? snap.data().balance : 0;
    balanceEl.textContent = `GHC ${bal}`;
    return bal;
  }
  // ✅ Load last 20 transactions
  async function loadTransactions() {
    txListEl.innerHTML = "Loading…";

    const q = query(TX_COLL, orderBy("timestamp", "desc"), limit(20));
    const snaps = await getDocs(q);

    txListEl.innerHTML = "";

    if (snaps.empty) {
      txListEl.innerHTML = "<p class='small'>No transactions yet.</p>";
      return;
    }

    snaps.forEach(docSnap => {
      const t = docSnap.data();
      const entry = document.createElement("div");
      entry.className = "tx";

      entry.innerHTML = `
        <strong>${t.type.toUpperCase()}</strong> — GHC ${t.amount}<br>
        <span class="small">${new Date(t.timestamp.toMillis()).toLocaleString()}</span><br>
        <span class="small">${t.note || ""}</span>
      `;

      txListEl.appendChild(entry);
    });
  }

  // ✅ Process fake top-up (for beta)
  async function processTopUp(amount) {
    const snap = await getDoc(WALLET_DOC);
    let current = snap.exists() ? snap.data().balance : 0;

    const newBalance = current + Number(amount);

    // update global wallet
    await updateDoc(WALLET_DOC, { balance: newBalance });

    // add transaction
    await addDoc(TX_COLL, {
      type: "topup",
      amount: Number(amount),
      timestamp: new Date(),
      note: "Beta test top-up"
    });

    await refreshBalance();
    await loadTransactions();

    alert(`✅ Top-up successful! New balance: GHC ${newBalance}`);
  }

  // ✅ Wire top-up buttons
  document.querySelectorAll(".topup").forEach(btn => {
    btn.addEventListener("click", async () => {
      const amt = Number(btn.dataset.amount);
      if (!amt) return;

      if (!confirm(`Confirm top-up of GHC ${amt}?`)) return;

      try {
        await ensureWalletExists();
        await processTopUp(amt);
      } catch (err) {
        console.error(err);
        alert("❌ Error during top-up. Check console.");
      }
    });
  });

  // ✅ Initialize page
  (async () => {
    try {
      await ensureWalletExists();
      await refreshBalance();
      await loadTransactions();
    } catch (err) {
      console.error(err);
      balanceEl.textContent = "Error";
      txListEl.textContent = "Error loading transactions.";
    }
  })();

</script>

