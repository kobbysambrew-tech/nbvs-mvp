<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NBVS Wallet — Top Up</title>

<style>
  body { font-family:"Segoe UI",Arial,sans-serif;background:#f8f9fa;margin:0 }
  header {
    background:linear-gradient(to right,#ce1126,#fcd116,#006b3f);
    color:#fff;padding:1.2rem;text-align:center
  }
  main {
    max-width:700px;margin:2rem auto;background:#fff;padding:1.6rem;
    border-radius:10px;box-shadow:0 3px 12px rgba(0,0,0,0.08)
  }
  .balance { font-size:2rem;color:#006b3f;font-weight:700;margin:0.5rem 0 }
  button {
    padding:10px 14px;border:none;border-radius:8px;cursor:pointer;
    margin:6px 0;width:100%;font-size:1rem
  }
  .topup { background:#ffd54f;color:#000 }
  .tx {
    background:#f5f5f5;padding:10px;border-radius:8px;margin-top:10px
  }
  .row { display:flex;gap:10px }
  .col { flex:1 }
  .small { font-size:0.95rem;color:#555 }
  a { color:#006b3f;text-decoration:none }
</style>
</head>

<body>
<header><h1>NBVS Global Wallet — Ghana Cedis (₵)</h1></header>

<main>
  <p class="small">
    This wallet is used by the NBVS system to store revenue from subscriptions & searches.
  </p>

  <h3>System Balance</h3>
  <div id="balance" class="balance">Loading…</div>

  <h3>Quick Top-Up (Simulated Beta Payments)</h3>

  <div class="row">
    <div class="col"><button class="topup" data-amount="30">Top up ₵30</
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc,
    collection, addDoc, getDocs, query, orderBy, limit
  } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

  // ✅ Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCDh_qL3jiCMHROK0_Soul2Wsv3t3y4wv0",
    authDomain: "nbvs-ghana.firebaseapp.com",
    projectId: "nbvs-ghana",
    storageBucket: "nbvs-ghana.firebasestorage.app",
    messagingSenderId: "702636577113",
    appId: "1:702636577113:web:8369b43a2aa43aeb95fc48",
    measurementId: "G-2FHFSQRMZX"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ✅ Wallet document
  const BALANCE_DOC = doc(db, "stats", "global"); 
  const TX_COLL = collection(db, "walletTransactions");

  const balanceEl = document.getElementById("balance");
  const txListEl = document.getElementById("txList");

  // ✅ Ensure wallet exists
  async function ensureWallet() {
    const snap = await getDoc(BALANCE_DOC);
    if (!snap.exists()) {
      await setDoc(BALANCE_DOC, { walletBalance: 0 });
      return 0;
    }
    return snap.data().walletBalance || 0;
  }

  // ✅ Refresh balance
  async function refreshBalance() {
    const snap = await getDoc(BALANCE_DOC);
    const bal = snap.exists() ? (snap.data().walletBalance || 0) : 0;
    balanceEl.textContent = `₵ ${bal}`;
    return bal;
  }

  // ✅ Load last 10 transactions
  async function loadTx() {
    txListEl.innerHTML = "Loading…";
    const q = query(TX_COLL, orderBy("timestamp", "desc"), limit(10));
    const snaps = await getDocs(q);

    txListEl.innerHTML = "";
    snaps.forEach(d => {
      const t = d.data();
      const item = document.createElement("div");
      item.className = "tx";
      item.innerHTML = `
        <strong>${t.type}</strong> — ₵${t.amount}<br>
        <span class="small">${new Date(t.timestamp).toLocaleString()}</span><br>
        <span class="small">${t.note || ""}</span>
      `;
      txListEl.appendChild(item);
    });

    if (!snaps.docs.length) {
      txListEl.innerHTML = "<p class='small'>No transactions yet.</p>";
    }
  }

  // ✅ Fake top-up (beta)
  async function fakeTopUp(amount) {
    const snap = await getDoc(BALANCE_DOC);
    let current = snap.exists() ? (snap.data().walletBalance || 0) : 0;
    const newBalance = current + amount;

    // Update wallet balance
    await updateDoc(BALANCE_DOC, { walletBalance: newBalance });

    // Add transaction
    await addDoc(TX_COLL, {
      type: "topup",
      amount,
      timestamp: Date.now(),
      note: "Beta payment simulation"
    });

    await refreshBalance();
    await loadTx();
    alert(`✅ Top-up successful — New balance: ₵${newBalance}`);
  }

  // ✅ Handle top-up buttons
  document.querySelectorAll(".topup").forEach(btn => {
    btn.addEventListener("click", async () => {
      const amt = Number(btn.dataset.amount);
      if (!amt) return;

      if (!confirm(`Simulate top-up of ₵${amt}?`)) return;

      try {
        await ensureWallet();
        await fakeTopUp(amt);
      } catch (err) {
        console.error(err);
        alert("Error processing top-up.");
      }
    });
  });

  // ✅ Init page
  (async () => {
    try {
      await ensureWallet();
      await refreshBalance();
      await loadTx();
    } catch (e) {
      console.error(e);
      balanceEl.textContent = "Error loading wallet";
      txListEl.textContent = "Error loading transactions";
    }
  })();
</script>
</body>
</html>

