<!DOCTYPE html>
<html>
<head>
  <title>NBVS Wallet</title>
  <style>
    body{font-family:Arial;background:#f8f9fa;padding:20px}
    h1{color:#006b3f}
    .panel{background:#fff;padding:15px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1);margin-top:15px}
    table{width:100%;margin-top:15px;border-collapse:collapse}
    th,td{border:1px solid #ccc;padding:10px}
    th{background:#006b3f;color:#fff}
    button{background:#006b3f;color:#fff;padding:10px 15px;border:none;border-radius:6px;cursor:pointer;width:100%}
  </style>
</head>

<body>
<h1>Wallet</h1>

<div class="panel">
  <p><b>Balance:</b> ¢<span id="balance">0</span></p>
  <button id="addCreditBtn">Add ¢30 Credit</button>
</div>

<div class="panel">
  <h3>Transactions</h3>
  <table>
    <thead>
      <tr><th>Amount</th><th>Type</th><th>Time</th></tr>
    </thead>
    <tbody id="walletLogs"></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
import { 
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, addDoc, getDocs 
} from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

/* ✅ FIREBASE CONFIG */
const firebaseConfig = {
  apiKey:"AIzaSyCDh_qL3jiCMHROK0_Soul2Wsv3t3y4wv0",
  authDomain:"nbvs-ghana.firebaseapp.com",
  projectId:"nbvs-ghana",
  storageBucket:"nbvs-ghana.firebasestorage.app",
  messagingSenderId:"702636577113",
  appId:"1:702636577113:web:8369b43a2aa43aeb95fc48"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ✅ REFERENCES */
const walletRef = doc(db,"wallet","publicUser");
const logsRef = collection(db,"wallet_transactions");

/* ✅ AUTO-CREATE WALLET */
async function ensureWalletExists() {
  const snap = await getDoc(walletRef);
  if (!snap.exists()) {
    await setDoc(walletRef, {
      balance: 0,
      createdAt: new Date()
    });
  }
}
await ensureWalletExists();

/* ✅ LOAD BALANCE */
async function loadWallet() {
  const snap = await getDoc(walletRef);
  document.getElementById("balance").textContent = snap.data().balance;
}

/* ✅ LOAD TRANSACTIONS */
async function loadLogs() {
  const snap = await getDocs(logsRef);
  const table = document.getElementById("walletLogs");
  table.innerHTML = "";

  snap.forEach(docSnap => {
    const d = docSnap.data();
    table.innerHTML += `
      <tr>
        <td>${d.amount}</td>
        <td>${d.type}</td>
        <td>${new Date(d.time.toMillis()).toLocaleString()}</td>
      </tr>
    `;
  });
}

/* ✅ ADD CREDIT BUTTON */
document.getElementById("addCreditBtn").addEventListener("click", async () => {
  const snap = await getDoc(walletRef);
  const newBalance = snap.data().balance + 30;

  await updateDoc(walletRef, { balance: newBalance });

  await addDoc(logsRef, {
    amount: "+30",
    type: "credit",
    time: new Date()
  });

  loadWallet();
  loadLogs();
  alert("✅ ¢30 added to your wallet.");
});

/* ✅ INITIAL LOAD */
loadWallet();
loadLogs();

</script>

</body>
</html>
