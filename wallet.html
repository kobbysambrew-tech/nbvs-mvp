<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NBVS — Wallet (Anonymous)</title>
<style>
:root{--green:#006b3f;--accent:#004f2e;--bg:#f6f7f9;--muted:#555}
body{font-family:"Segoe UI",Arial,sans-serif;background:var(--bg);margin:0;color:#222}
header{background:linear-gradient(90deg,#ce1126,#fcd116,#006b3f);padding:16px;text-align:center;color:#fff}
main{max-width:900px;margin:16px auto;padding:0 16px}
.panel{background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.06);margin-bottom:16px}
.btn{padding:12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
.btn-green{background:var(--green);color:#fff}
.btn-yellow{background:#fcd116;color:#111}
.table{width:100%;border-collapse:collapse;margin-top:12px}
.table th,.table td{padding:10px;border-bottom:1px solid #eee;text-align:left}
.small{font-size:.9rem;color:var(--muted)}
</style>
</head>
<body>
<header><h1>NBVS — Wallet</h1></header>
<main>
  <div class="panel">
    <h2>Your Wallet</h2>
    <p style="font-size:1.6rem;font-weight:700">¢<span id="balance">0</span></p>
    <p class="small">One verification costs ¢30</p>

    <div style="display:flex;gap:10px;margin-top:12px">
      <button id="add10" class="btn btn-green" style="flex:1">Add ¢10</button>
      <button id="add30" class="btn btn-green" style="flex:1">Add ¢30</button>
      <button id="add100" class="btn btn-green" style="flex:1">Add ¢100</button>
    </div>

    <div style="margin-top:12px">
      <button id="back" class="btn btn-yellow" style="width:100%">← Back to Verify</button>
    </div>
  </div>

  <div class="panel">
    <h3>Transactions</h3>
    <table class="table" id="txTable">
      <thead><tr><th>Time</th><th>Type</th><th>Amount</th></tr></thead>
      <tbody id="txBody"><tr><td colspan="3">Loading…</td></tr></tbody>
    </table>
  </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, getDocs, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyCDh_qL3jiCMHROK0_Soul2Wsv3t3y4wv0",
  authDomain:"nbvs-ghana.firebaseapp.com",
  projectId:"nbvs-ghana",
  storageBucket:"nbvs-ghana.firebasestorage.app",
  messagingSenderId:"702636577113",
  appId:"1:702636577113:web:8369b43a2aa43aeb95fc48"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const DEVICE_KEY = 'nbvs_deviceId';
let deviceId = localStorage.getItem(DEVICE_KEY);
if(!deviceId){
  deviceId = 'dev_' + Math.random().toString(36).slice(2,12);
  localStorage.setItem(DEVICE_KEY, deviceId);
}
const walletRef = doc(db, 'wallet', deviceId);

const balanceEl = document.getElementById('balance');
const txBody = document.getElementById('txBody');

async function ensureDoc(){
  const snap = await getDoc(walletRef);
  if(!snap.exists()){
    await setDoc(walletRef, {
      balance: 0,
      freeSearchesRemaining: 3,
      plan: 'free',
      monthlyRemaining: 0,
      planExpires: null,
      createdAt: new Date()
    });
  }
}

// Live wallet updates
function listenWallet(){
  onSnapshot(walletRef, (snap)=>{
    if(!snap.exists()) return;
    const data = snap.data();
    balanceEl.innerText = Number(data.balance ?? 0);
    // optional: update free searches or plan
  });
}

// Load transaction history
async function loadTx(){
  txBody.innerHTML = '<tr><td colspan="3">Loading…</td></tr>';
  const q = query(collection(db,'wallet_transactions'), orderBy('timestamp','desc'));
  const snap = await getDocs(q);
  if(snap.empty){
    txBody.innerHTML = '<tr><td colspan="3">No transactions yet</td></tr>';
    return;
  }
  txBody.innerHTML = '';
  snap.forEach(d=>{
    const r = d.data();
    const time = r.timestamp?.toDate ? r.timestamp.toDate().toLocaleString() : (r.timestamp ? new Date(r.timestamp).toLocaleString() : '—');
    txBody.innerHTML += `<tr><td>${time}</td><td>${r.type||''}</td><td>¢${r.amount||0}</td></tr>`;
  });
}

// Add money function
async function addMoney(amount){
  const snap = await getDoc(walletRef);
  const bal = Number(snap.exists() ? snap.data().balance || 0 : 0);
  await updateDoc(walletRef, { balance: bal + amount });
  await addDoc(collection(db,'wallet_transactions'), { deviceId, type: 'top_up', amount, timestamp: new Date() });
}

document.getElementById('add10').onclick = ()=> addMoney(10);
document.getElementById('add30').onclick = ()=> addMoney(30);
document.getElementById('add100').onclick = ()=> addMoney(100);
document.getElementById('back').onclick = ()=> window.location.href = 'verify.html';

(async()=>{
  await ensureDoc();
  listenWallet(); // live balance updates
  await loadTx(); // load transactions once
  console.log('wallet loaded and listening for device', deviceId);
})();
</script>
</body>
</html>
