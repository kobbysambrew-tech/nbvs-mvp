<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NBVS Wallet — Top Up (Ghana)</title>

<style>
  body {
    font-family:"Segoe UI",Arial,sans-serif;
    background:#f8f9fa;
    margin:0;
  }
  header {
    background:linear-gradient(to right,#ce1126,#fcd116,#006b3f);
    color:#fff;
    padding:1.2rem;
    text-align:center;
  }
  main {
    max-width:700px;
    margin:2rem auto;
    background:#fff;
    padding:1.6rem;
    border-radius:10px;
    box-shadow:0 3px 12px rgba(0,0,0,0.08);
  }
  .balance {
    font-size:2rem;
    color:#006b3f;
    font-weight:700;
    margin:0.5rem 0;
  }
  .topup {
    background:#fcd116;
    color:#000;
    padding:12px 18px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    width:100%;
    margin:6px 0;
    font-size:1rem;
    font-weight:bold;
  }
  .tx {
    background:#f1f1f1;
    padding:10px;
    border-radius:8px;
    margin-top:10px;
  }
  .small { color:#555; }
  a { color:#006b3f; text-decoration:none; }
</style>
</head>

<body>
<header>
  <h1>NBVS Wallet — Global Balance</h1>
</header>

<main>
  <p class="small">
    This is the NBVS Beta Wallet.  
    Each background lookup costs <b>GHC 30</b>.
  </p>

  <div>
    <h3>Wallet Balance</h3>
    <div id="balance" class="balance">Loading…</div>
  </div>

  <h3>Quick Top-Up</h3>
  
  <button class="topup" data-amount="30">Add GHC 30</button>
  <button class="topup" data-amount="50">Add GHC 50</button>
  <button class="topup" data-amount="100">Add GHC 100</button>
  <button class="topup" data-amount="200">Add GHC 200</button>

  <h3>Recent Transactions</h3>
  <div id="txList">Loading…</div>

  <p><a href="verify.html">← Back to Verify</a></p>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
import { 
  getFirestore, doc, getDoc, setDoc, updateDoc, 
  collection, getDocs, addDoc 
} from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

// ✅ Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCDh_qL3jiCMHROK0_Soul2Wsv3t3y4wv0",
  authDomain: "nbvs-ghana.firebaseapp.com",
  projectId: "nbvs-ghana",
  storageBucket: "nbvs-ghana.firebasestorage.app",
  messagingSenderId: "702636577113",
  appId: "1:702636577113:web:8369b43a2aa43aeb95fc48",
  measurementId: "G-2FHFSQRMZX"
};

// ✅ Init
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ✅ Users
const userId = "publicUser";

// ✅ Stats docs
const statsDoc = doc(db, "stats", "global");
const searchLogs = collection(db, "search_logs");

// ✅ Wallet
const WALLET_DOC = doc(db, "wallet", "global");

// ✅ UI elements
const searchBtn = document.getElementById("searchBtn");
const searchInput = document.getElementById("searchInput");
const resultsDiv = document.getElementById("results");

// ✅ Subscription Elements
const freeDisplay = document.querySelector("#freeCount");
const planDisplay = document.querySelector("#planDisplay");

// ✅ Local user storage
function getUser() {
  return {
    freeSearches: parseInt(localStorage.getItem("freeSearches") || "3"),
    plan: localStorage.getItem("plan") || "FREE",
    planExpires: localStorage.getItem("planExpires") || null
  };
}

function saveUser(data) {
  localStorage.setItem("freeSearches", data.freeSearches);
  localStorage.setItem("plan", data.plan);
  if (data.planExpires) localStorage.setItem("planExpires", data.planExpires);
}

function updateUI() {
  const u = getUser();
  freeDisplay.textContent = u.freeSearches;
  planDisplay.textContent = u.plan;
}

updateUI();

// ✅ Wallet top-up (used later)
async function deductWallet(amount) {
  const snap = await getDoc(WALLET_DOC);
  let bal = snap.exists() ? snap.data().balance : 0;
  if (bal < amount) return false;

  await updateDoc(WALLET_DOC, { balance: bal - amount });
  return true;
}

// ✅ MAIN SEARCH FUNCTION
async function runSearch() {
  const query = searchInput.value.trim().toLowerCase();
  if (!query) {
    resultsDiv.innerHTML = `<p style="color:#c00;">Enter a valid name or NIA ID.</p>`;
    return;
  }

  const user = getUser();

  // ✅ PRO = unlimited
  if (user.plan !== "PRO") {
    if (user.freeSearches <= 0) {
      resultsDiv.innerHTML = `
        <div style="text-align:center;padding:20px;">
          <h3>⚠️ You have no searches left</h3>
          <p>Upgrade or use wallet credits.</p>
        </div>`;
      return;
    }

    user.freeSearches -= 1;
    saveUser(user);
    updateUI();
  }

  resultsDiv.innerHTML = "Searching…";

  // ✅ FIRESTORE QUERY
  const docs = await getDocs(collection(db, "records"));
  let matches = [];

  docs.forEach(doc => {
    const r = doc.data();
    if (r.name?.toLowerCase() === query || r.nia?.toLowerCase() === query) {
      matches.push(r);
    }
  });

  // ✅ Log search
  await addDoc(searchLogs, {
    term: query,
    timestamp: new Date(),
    platform: "verify"
  });

  // ✅ Update global search count
  await updateDoc(statsDoc, {
    totalSearches: (await getDoc(statsDoc)).data().totalSearches + 1
  });

  if (matches.length === 0) {
    resultsDiv.innerHTML = `<p style="color:#c00;">❌ No record found.</p>`;
    return;
  }

  resultsDiv.innerHTML = "";
  matches.forEach(r => {
    resultsDiv.innerHTML += `
      <div class="record">
        <h3>${r.name} — <span>${r.status}</span></h3>
        <p><b>NIA:</b> ${r.nia}</p>
        <p><b>DoB:</b> ${r.dob}</p>
        <p><b>Region:</b> ${r.region}</p>
        <p><b>Criminal:</b> ${r.criminal}</p>
        <p><b>Driving:</b> ${r.driving}</p>
        <p><b>Address:</b> ${r.address}</p>
        <p><b>Credit:</b> ${r.credit}</p>
      </div>`;
  });
}

// ✅ Connect button
searchBtn.addEventListener("click", runSearch);

// ✅ Open wallet
document.getElementById("openWallet").addEventListener("click", () => {
  window.location.href = "wallet.html";
});
</script>

  
</body>
</html>
